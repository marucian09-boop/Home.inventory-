<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daily Sales & Inventory</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --font-sans: 'Inter', sans-serif;
            /* Light Theme Colors */
            --bg-primary: #f3f4f6; /* gray-100 */
            --bg-secondary: #ffffff; /* white */
            --bg-tertiary: #f9fafb; /* gray-50 */
            --border-primary: #e5e7eb; /* gray-200 */
            --text-primary: #111827; /* gray-900 */
            --text-secondary: #6b7280; /* gray-500 */
            --accent-primary: #3b82f6; /* blue-500 */
            --accent-primary-hover: #2563eb; /* blue-600 */
            --destructive: #ef4444; /* red-500 */
            --destructive-hover: #dc2626; /* red-600 */
            --success: #22c55e; /* green-500 */
            --success-hover: #16a34a; /* green-600 */
            --special: #a855f7; /* purple-500 */
            --special-hover: #9333ea; /* purple-600 */
            
            --info-bg: #eff6ff; /* blue-50 */
            --info-text: #1e3a8a; /* blue-900 */
            --success-card-bg: #f0fdf4; /* green-50 */
            --success-card-text: #14532d; /* green-900 */
            --warning-bg: #fefce8; /* yellow-50 */
            --warning-text: #713f12; /* yellow-900 */

            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }

        .dark {
            /* Dark Theme Colors */
            --bg-primary: #111827; /* gray-900 */
            --bg-secondary: #1f2937; /* gray-800 */
            --bg-tertiary: #374151; /* gray-700 */
            --border-primary: #4b5563; /* gray-600 */
            --text-primary: #f9fafb; /* gray-50 */
            --text-secondary: #9ca3af; /* gray-400 */
            --accent-primary: #60a5fa; /* blue-400 */
            --accent-primary-hover: #3b82f6; /* blue-500 */
            --destructive: #f87171; /* red-400 */
            --destructive-hover: #ef4444; /* red-500 */
            --success: #4ade80; /* green-400 */
            --success-hover: #22c55e; /* green-500 */
            --special: #c084fc; /* purple-400 */
            --special-hover: #a855f7; /* purple-500 */

            --info-bg: #1e2937; 
            --info-text: #93c5fd; 
            --success-card-bg: #1e2937; 
            --success-card-text: #86efac;
            --warning-bg: #1e2937;
            --warning-text: #fde047;
        }

        body {
            font-family: var(--font-sans);
            background-color: var(--bg-primary);
            color: var(--text-primary);
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        .tab-active {
            border-bottom-color: var(--accent-primary);
            color: var(--accent-primary);
            font-weight: 600;
        }
        .table-container {
            max-height: 60vh;
            overflow-y: auto;
        }
        .form-input, .form-select {
            transition: all 0.3s ease;
            background-color: var(--bg-primary);
            border-color: var(--border-primary);
        }
        .form-input:focus, .form-select:focus {
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 2px color-mix(in srgb, var(--accent-primary) 20%, transparent);
            outline: none;
        }
        .form-input::placeholder {
            color: var(--text-secondary);
        }

        /* Toggle Switch */
        .switch { position: relative; display: inline-block; width: 44px; height: 24px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: var(--bg-tertiary); transition: .4s; border-radius: 24px; }
        .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--accent-primary); }
        input:checked + .slider:before { transform: translateX(20px); }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg-primary); }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
    </style>
</head>
<body class="antialiased">

    <!-- Auth Container -->
    <div id="auth-container" class="min-h-screen flex items-center justify-center">
        <div class="max-w-md w-full space-y-8 p-10 rounded-xl shadow-lg" style="background-color: var(--bg-secondary);">
            <div>
                <h2 class="mt-6 text-center text-3xl font-extrabold" style="color: var(--text-primary);">
                    Sign in or create an account
                </h2>
            </div>
            <div id="auth-error" class="text-center p-2 rounded-md" style="color: var(--destructive); display: none;"></div>
            <!-- Auth Forms -->
            <div id="signin-form">
                <input type="email" id="signin-email" placeholder="Email address" class="form-input w-full p-2 border rounded-md mb-4">
                <input type="password" id="signin-password" placeholder="Password" class="form-input w-full p-2 border rounded-md mb-4">
                <button id="signin-btn" style="background-color: var(--accent-primary);" class="w-full text-white font-semibold py-2 px-4 rounded-md transition-colors disabled:opacity-50">Sign In</button>
                <p class="mt-4 text-center text-sm" style="color: var(--text-secondary);">
                    No account? <button id="show-signup-btn" class="font-medium hover:underline" style="color: var(--accent-primary);">Sign up</button>
                </p>
            </div>
            <div id="signup-form" class="hidden">
                 <input type="email" id="signup-email" placeholder="Email address" class="form-input w-full p-2 border rounded-md mb-4">
                <input type="password" id="signup-password" placeholder="Password" class="form-input w-full p-2 border rounded-md mb-4">
                <button id="signup-btn" style="background-color: var(--success);" class="w-full text-white font-semibold py-2 px-4 rounded-md transition-colors">Create Account</button>
                <p class="mt-4 text-center text-sm" style="color: var(--text-secondary);">
                    Already have an account? <button id="show-signin-btn" class="font-medium hover:underline" style="color: var(--accent-primary);">Sign in</button>
                </p>
            </div>
        </div>
    </div>


    <!-- App Container -->
    <div id="app-container" class="hidden container mx-auto p-4 sm:p-6 lg:p-8">
        <header class="mb-8 flex justify-between items-center">
            <div>
                <h1 class="text-3xl font-bold" style="color: var(--text-primary);">Inventory Dashboard</h1>
                <div id="user-info" class="flex items-center gap-4">
                    <p style="color: var(--text-secondary);" id="user-email"></p>
                    <span id="user-role-badge" class="text-xs font-semibold px-2 py-1 rounded-full"></span>
                    <button id="signout-btn" style="background-color: var(--destructive);" class="text-white text-xs font-semibold py-1 px-3 rounded-md transition-colors">Sign Out</button>
                </div>
            </div>
            <div class="flex items-center space-x-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="color: var(--text-secondary);"><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"/></svg>
                <label class="switch">
                    <input type="checkbox" id="darkModeToggle">
                    <span class="slider"></span>
                </label>
            </div>
        </header>
        
        <div id="view-only-banner" class="hidden mb-4 p-4 rounded-md text-center" style="background-color: var(--warning-bg); color: var(--warning-text);">
            You have view-only access.
        </div>

        <!-- Main Content -->
        <div style="background-color: var(--bg-secondary); box-shadow: var(--shadow-lg);" class="rounded-xl p-4 sm:p-6">
            <!-- Tabs -->
            <div style="border-color: var(--border-primary);" class="border-b mb-6">
                <nav id="tabs-nav" class="-mb-px flex space-x-6 overflow-x-auto" aria-label="Tabs">
                    <button onclick="changeTab('dashboard')" class="tab whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm hover:text-blue-500 hover:border-blue-500 tab-active" data-tab="dashboard" style="color: var(--text-secondary);">Dashboard</button>
                    <button onclick="changeTab('deliveries')" class="tab whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm hover:text-blue-500 hover:border-blue-500" data-tab="deliveries" style="color: var(--text-secondary);">Deliveries</button>
                    <button onclick="changeTab('stocks')" class="tab whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm hover:text-blue-500 hover:border-blue-500" data-tab="stocks" style="color: var(--text-secondary);">Stocks</button>
                    <button onclick="changeTab('sales')" class="tab whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm hover:text-blue-500 hover:border-blue-500" data-tab="sales" style="color: var(--text-secondary);">Sales Today</button>
                    <button onclick="changeTab('transferOut')" class="tab whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm hover:text-blue-500 hover:border-blue-500" data-tab="transferOut" style="color: var(--text-secondary);">Stock Transfer Out</button>
                    <button onclick="changeTab('transferIn')" class="tab whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm hover:text-blue-500 hover:border-blue-500" data-tab="transferIn" style="color: var(--text-secondary);">Stock Transfer In</button>
                    <button onclick="changeTab('stockLevel')" class="tab whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm hover:text-blue-500 hover:border-blue-500" data-tab="stockLevel" style="color: var(--text-secondary);">Stock Level</button>
                    <button id="admin-tab-btn" onclick="changeTab('admin')" class="tab hidden whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm hover:text-blue-500 hover:border-blue-500" data-tab="admin" style="color: var(--text-secondary);">Admin Tools</button>
                </nav>
            </div>

            <!-- Tab Content -->
            <div id="tab-content">
                <!-- Dashboard -->
                <div id="dashboard" class="tab-pane">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div style="background-color: var(--info-bg); color: var(--info-text);" class="p-6 rounded-lg">
                            <h3 class="font-semibold text-lg">Daily Sales</h3>
                            <p class="text-3xl font-bold mt-2" id="dashboard-sales">₱0.00</p>
                        </div>
                        <div style="background-color: var(--success-card-bg); color: var(--success-card-text);" class="p-6 rounded-lg">
                            <h3 class="font-semibold text-lg">Total Stock Items</h3>
                            <p class="text-3xl font-bold mt-2" id="dashboard-stock">0</p>
                        </div>
                        <div style="background-color: var(--warning-bg); color: var(--warning-text);" class="p-6 rounded-lg">
                            <h3 class="font-semibold text-lg">Running Incentives</h3>
                            <p class="text-3xl font-bold mt-2" id="dashboard-incentives">₱0.00</p>
                        </div>
                    </div>
                </div>

                <!-- Deliveries -->
                <div id="deliveries" class="tab-pane hidden">
                    <h2 class="text-xl font-semibold mb-4">Add New Deliveries</h2>
                    <form id="delivery-form" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <input type="text" id="del-imei" placeholder="15-Digit IMEI" class="form-input w-full p-2 border rounded-md" maxlength="15" required>
                        <input type="text" id="del-brand" placeholder="Brand" class="form-input w-full p-2 border rounded-md" required>
                        <input type="text" id="del-model" placeholder="Model" class="form-input w-full p-2 border rounded-md" required>
                        <input type="text" id="del-variant" placeholder="Variant (e.g., 128GB)" class="form-input w-full p-2 border rounded-md">
                        <input type="text" id="del-color" placeholder="Color" class="form-input w-full p-2 border rounded-md">
                        <input type="number" id="del-price" placeholder="Price" class="form-input w-full p-2 border rounded-md" required>
                        <input type="text" id="del-notes" placeholder="Notes" class="form-input md:col-span-2 lg:col-span-1 w-full p-2 border rounded-md">
                        <button type="submit" style="background-color: var(--accent-primary);" class="md:col-span-2 lg:col-span-3 text-white font-semibold py-2 px-4 rounded-md transition-colors">Add to Stock</button>
                    </form>
                </div>
                
                <!-- Stocks -->
                <div id="stocks" class="tab-pane hidden">
                    <h2 class="text-xl font-semibold mb-4">Current Stock</h2>
                    <div class="table-container">
                        <table class="min-w-full">
                            <thead style="background-color: var(--bg-tertiary);" class="sticky top-0">
                                <tr>
                                    <th class="py-2 px-4 border-b text-left" style="border-color: var(--border-primary);">IMEI</th>
                                    <th class="py-2 px-4 border-b text-left" style="border-color: var(--border-primary);">Brand</th>
                                    <th class="py-2 px-4 border-b text-left" style="border-color: var(--border-primary);">Model</th>
                                    <th class="py-2 px-4 border-b text-left" style="border-color: var(--border-primary);">Variant</th>
                                    <th class="py-2 px-4 border-b text-left" style="border-color: var(--border-primary);">Color</th>
                                    <th class="py-2 px-4 border-b text-left" style="border-color: var(--border-primary);">Price</th>
                                    <th class="py-2 px-4 border-b text-left" style="border-color: var(--border-primary);">Notes</th>
                                    <th class="py-2 px-4 border-b text-center" style="border-color: var(--border-primary);">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="stock-table-body"></tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Sales Today -->
                <div id="sales" class="tab-pane hidden">
                    <h2 class="text-xl font-semibold mb-4">Record a Sale</h2>
                    <form id="sales-form" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <input type="text" id="sale-imei" placeholder="15-Digit IMEI of sold item" class="form-input w-full p-2 border rounded-md" maxlength="15" required>
                        <input type="number" id="sale-incentive" placeholder="Incentive" class="form-input w-full p-2 border rounded-md" required>
                        <input type="text" id="sale-notes" placeholder="Notes" class="form-input w-full p-2 border rounded-md">
                        <button type="submit" style="background-color: var(--success);" class="md:col-span-2 lg:col-span-3 text-white font-semibold py-2 px-4 rounded-md transition-colors">Record Sale</button>
                    </form>
                    <h3 class="text-lg font-semibold mt-8 mb-4">Today's Sales</h3>
                     <div class="table-container">
                        <table class="min-w-full">
                            <thead style="background-color: var(--bg-tertiary);" class="sticky top-0">
                                <tr>
                                    <th class="py-2 px-4 border-b text-left" style="border-color: var(--border-primary);">IMEI</th>
                                    <th class="py-2 px-4 border-b text-left" style="border-color: var(--border-primary);">Brand</th>
                                    <th class="py-2 px-4 border-b text-left" style="border-color: var(--border-primary);">Model</th>
                                    <th class="py-2 px-4 border-b text-left" style="border-color: var(--border-primary);">Price</th>
                                    <th class="py-2 px-4 border-b text-left" style="border-color: var(--border-primary);">Incentive</th>
                                    <th class="py-2 px-4 border-b text-left" style="border-color: var(--border-primary);">Notes</th>
                                </tr>
                            </thead>
                            <tbody id="sales-table-body"></tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Stock Transfer Out -->
                <div id="transferOut" class="tab-pane hidden">
                    <h2 class="text-xl font-semibold mb-4">Transfer Stock Out</h2>
                    <form id="transfer-out-form" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <input type="text" id="tout-imei" placeholder="15-Digit IMEI" class="form-input w-full p-2 border rounded-md" maxlength="15" required>
                        <input type="text" id="tout-notes" placeholder="Notes (e.g., Destination)" class="form-input w-full p-2 border rounded-md md:col-span-2 lg:col-span-2">
                        <button type="submit" style="background-color: var(--destructive);" class="md:col-span-2 lg:col-span-3 text-white font-semibold py-2 px-4 rounded-md transition-colors">Transfer Out</button>
                    </form>
                    <h3 class="text-lg font-semibold mt-8 mb-4">Today's Transfers Out</h3>
                    <div class="table-container">
                        <table class="min-w-full">
                            <thead style="background-color: var(--bg-tertiary);" class="sticky top-0">
                                <tr>
                                    <th class="py-2 px-4 border-b text-left" style="border-color: var(--border-primary);">IMEI</th>
                                    <th class="py-2 px-4 border-b text-left" style="border-color: var(--border-primary);">Brand</th>
                                    <th class="py-2 px-4 border-b text-left" style="border-color: var(--border-primary);">Model</th>
                                    <th class="py-2 px-4 border-b text-left" style="border-color: var(--border-primary);">Notes</th>
                                    <th class="py-2 px-4 border-b text-center" style="border-color: var(--border-primary);">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="transfer-out-table-body"></tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Stock Transfer In -->
                <div id="transferIn" class="tab-pane hidden">
                     <h2 class="text-xl font-semibold mb-4">Transfer Stock In</h2>
                    <form id="transfer-in-form" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <input type="text" id="tin-imei" placeholder="15-Digit IMEI" class="form-input w-full p-2 border rounded-md" maxlength="15" required>
                        <input type="text" id="tin-brand" placeholder="Brand" class="form-input w-full p-2 border rounded-md" required>
                        <input type="text" id="tin-model" placeholder="Model" class="form-input w-full p-2 border rounded-md" required>
                        <input type="text" id="tin-variant" placeholder="Variant" class="form-input w-full p-2 border rounded-md">
                        <input type="text" id="tin-color" placeholder="Color" class="form-input w-full p-2 border rounded-md">
                        <input type="number" id="tin-price" placeholder="Price" class="form-input w-full p-2 border rounded-md" required>
                        <input type="text" id="tin-notes" placeholder="Notes (e.g., Origin)" class="form-input md:col-span-2 lg:col-span-1 w-full p-2 border rounded-md">
                        <button type="submit" style="background-color: var(--special);" class="md:col-span-2 lg:col-span-3 text-white font-semibold py-2 px-4 rounded-md transition-colors">Transfer In</button>
                    </form>
                    <h3 class="text-lg font-semibold mt-8 mb-4">Today's Transfers In</h3>
                    <div class="table-container">
                        <table class="min-w-full">
                            <thead style="background-color: var(--bg-tertiary);" class="sticky top-0">
                                <tr>
                                    <th class="py-2 px-4 border-b text-left" style="border-color: var(--border-primary);">IMEI</th>
                                    <th class="py-2 px-4 border-b text-left" style="border-color: var(--border-primary);">Brand</th>
                                    <th class="py-2 px-4 border-b text-left" style="border-color: var(--border-primary);">Model</th>
                                    <th class="py-2 px-4 border-b text-left" style="border-color: var(--border-primary);">Notes</th>
                                    <th class="py-2 px-4 border-b text-center" style="border-color: var(--border-primary);">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="transfer-in-table-body"></tbody>
                        </table>
                    </div>
                </div>

                <!-- Stock Level -->
                <div id="stockLevel" class="tab-pane hidden">
                    <h2 class="text-xl font-semibold mb-4">Stock Level Check</h2>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div>
                            <h3 class="font-semibold text-lg mb-2" style="color: var(--success);">High Stock Products</h3>
                            <div id="high-stock-list" class="space-y-2"></div>
                        </div>
                         <div>
                            <h3 class="font-semibold text-lg mb-2" style="color: var(--destructive);">Low Stock Products</h3>
                            <div id="low-stock-list" class="space-y-2"></div>
                        </div>
                    </div>
                </div>
                
                <!-- Admin Tools -->
                <div id="admin" class="tab-pane hidden">
                    <h2 class="text-xl font-semibold mb-4">Manage User Roles</h2>
                    <div class="table-container">
                        <table class="min-w-full">
                             <thead style="background-color: var(--bg-tertiary);" class="sticky top-0">
                                <tr>
                                    <th class="py-2 px-4 border-b text-left" style="border-color: var(--border-primary);">User Email</th>
                                    <th class="py-2 px-4 border-b text-left" style="border-color: var(--border-primary);">Current Role</th>
                                    <th class="py-2 px-4 border-b text-left" style="border-color: var(--border-primary);">Change Role</th>
                                </tr>
                            </thead>
                            <tbody id="user-management-table-body">
                                <!-- User list will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>

            </div>
        </div>
        
        <!-- Toast Notification -->
        <div id="toast" class="fixed bottom-5 right-5 text-white py-2 px-4 rounded-lg shadow-lg opacity-0 transition-opacity duration-300">
            <span id="toast-message"></span>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirm-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div style="background-color: var(--bg-secondary);" class="rounded-lg shadow-lg p-6 w-full max-w-sm text-center">
            <h3 class="text-lg font-bold mb-4" id="confirm-modal-title">Confirm Action</h3>
            <p style="color: var(--text-secondary);" class="mb-6" id="confirm-modal-message"></p>
            <div class="flex justify-center gap-4">
                <button id="confirm-cancel-btn" class="py-2 px-4 rounded-md font-semibold w-24" style="background-color: var(--bg-tertiary); color: var(--text-primary);">Cancel</button>
                <button id="confirm-ok-btn" class="py-2 px-4 rounded-md font-semibold text-white w-24">Confirm</button>
            </div>
        </div>
    </div>

    <!-- Edit Item Modal -->
    <div id="edit-item-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div style="background-color: var(--bg-secondary);" class="rounded-lg shadow-lg p-6 w-full max-w-2xl">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold" id="edit-modal-title">Edit Stock Item</h3>
                <button id="edit-modal-close-btn">&times;</button>
            </div>
            <form id="edit-item-form">
                <input type="hidden" id="edit-item-id">
                <input type="hidden" id="edit-item-type">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <input type="text" id="edit-imei" placeholder="15-Digit IMEI" class="form-input w-full p-2 border rounded-md" maxlength="15" required disabled>
                    <input type="text" id="edit-brand" placeholder="Brand" class="form-input w-full p-2 border rounded-md" required>
                    <input type="text" id="edit-model" placeholder="Model" class="form-input w-full p-2 border rounded-md" required>
                    <input type="text" id="edit-variant" placeholder="Variant" class="form-input w-full p-2 border rounded-md">
                    <input type="text" id="edit-color" placeholder="Color" class="form-input w-full p-2 border rounded-md">
                    <input type="number" id="edit-price" placeholder="Price" class="form-input w-full p-2 border rounded-md" required>
                    <textarea id="edit-notes" placeholder="Notes" class="form-input w-full p-2 border rounded-md md:col-span-2" rows="2"></textarea>
                </div>
                <div class="flex justify-end gap-4 mt-6">
                     <button type="button" id="edit-modal-cancel-btn" class="py-2 px-4 rounded-md font-semibold w-32" style="background-color: var(--bg-tertiary); color: var(--text-primary);">Cancel</button>
                     <button type="submit" class="py-2 px-4 rounded-md font-semibold text-white w-32" style="background-color: var(--success);">Save Changes</button>
                </div>
            </form>
        </div>
    </div>


<script type="module">
    // --- Firebase SDKs ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { 
        getAuth, 
        onAuthStateChanged, 
        createUserWithEmailAndPassword, 
        signInWithEmailAndPassword, 
        signOut 
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { 
        getFirestore, 
        doc, 
        setDoc,
        updateDoc,
        deleteDoc,
        getDoc,
        getDocs,
        addDoc, 
        collection, 
        query, 
        onSnapshot,
        where,
        limit,
        serverTimestamp,
        runTransaction
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // --- Firebase Config ---
    const firebaseConfig = {
        apiKey: "AIzaSyCRoM0688XXI5q51uV_dBPVu6pmomSGwss",
        authDomain: "inventory-d4c22.firebaseapp.com",
        databaseURL: "https://inventory-d4c22-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "inventory-d4c22",
        storageBucket: "inventory-d4c22.firebasestorage.app",
        messagingSenderId: "99206301025",
        appId: "1:99206301025:web:8c636434bdfb69af3a3120",
        measurementId: "G-5C5DETNZG7"
    };

    // --- Firebase Initialization ---
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // --- Global State ---
    let currentUserRole = null;
    let usersUnsubscribe = null;
    let inventoryUnsubscribe = null;
    let salesUnsubscribe = null;
    let transfersInUnsubscribe = null;
    let transfersOutUnsubscribe = null;
    let inventory = [];
    let sales = [];
    let transfersIn = [];
    let transfersOut = [];
    
    // --- UI Elements ---
    const authContainer = document.getElementById('auth-container');
    const appContainer = document.getElementById('app-container');
    const authError = document.getElementById('auth-error');

    const signinForm = document.getElementById('signin-form');
    const signupForm = document.getElementById('signup-form');

    const showSignupBtn = document.getElementById('show-signup-btn');
    const showSigninBtn = document.getElementById('show-signin-btn');

    const signinBtn = document.getElementById('signin-btn');
    const signupBtn = document.getElementById('signup-btn');
    const signoutBtn = document.getElementById('signout-btn');
    
    const confirmModal = document.getElementById('confirm-modal');
    const confirmOkBtn = document.getElementById('confirm-ok-btn');
    const confirmCancelBtn = document.getElementById('confirm-cancel-btn');
    const confirmModalTitle = document.getElementById('confirm-modal-title');
    const confirmModalMessage = document.getElementById('confirm-modal-message');

    const editItemModal = document.getElementById('edit-item-modal');
    const editItemForm = document.getElementById('edit-item-form');
    const editModalCloseBtn = document.getElementById('edit-modal-close-btn');
    const editModalCancelBtn = document.getElementById('edit-modal-cancel-btn');
    const editModalTitle = document.getElementById('edit-modal-title');

    // --- DARK MODE ---
    const darkModeToggle = document.getElementById("darkModeToggle");
    
    function applyDarkMode(isDark) { 
        document.documentElement.classList.toggle('dark', isDark);
        localStorage.setItem("darkMode", isDark);
    }
    
    const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
    const savedMode = localStorage.getItem("darkMode");
    const initialDarkMode = savedMode !== null ? savedMode === 'true' : prefersDark;
    darkModeToggle.checked = initialDarkMode;
    applyDarkMode(initialDarkMode);


    // --- UTILITY FUNCTIONS ---
    const showToast = (message, type = 'success') => {
        const toast = document.getElementById('toast');
        const toastMessage = document.getElementById('toast-message');
        toastMessage.textContent = message;

        toast.classList.remove('bg-red-500', 'bg-green-500');
        toast.style.backgroundColor = '';

        if (type === 'error') {
            toast.style.backgroundColor = 'var(--destructive)';
        } else {
            toast.style.backgroundColor = 'var(--success)';
        }

        toast.classList.remove('opacity-0');
        toast.classList.add('opacity-100');

        setTimeout(() => {
            toast.classList.remove('opacity-100');
            toast.classList.add('opacity-0');
        }, 3000);
    };
    
    let confirmCallback = null;
    const showConfirm = (message, onConfirm, options = {}) => {
        const { title = 'Confirm Action', okText = 'Confirm', okClass = 'destructive' } = options;
        
        confirmModalTitle.textContent = title;
        confirmModalMessage.textContent = message;
        confirmOkBtn.textContent = okText;

        confirmOkBtn.style.backgroundColor = ''; // Reset
        if(okClass === 'destructive') {
            confirmOkBtn.style.backgroundColor = 'var(--destructive)';
        } else {
            confirmOkBtn.style.backgroundColor = 'var(--success)';
        }

        confirmModal.classList.remove('hidden');
        confirmCallback = onConfirm;
    };

    confirmOkBtn.addEventListener('click', () => {
        if (confirmCallback) {
            confirmCallback();
        }
        confirmModal.classList.add('hidden');
        confirmCallback = null;
    });

    confirmCancelBtn.addEventListener('click', () => {
        confirmModal.classList.add('hidden');
        confirmCallback = null;
    });

    const formatCurrency = (amount) => {
        return new Intl.NumberFormat('en-PH', { style: 'currency', currency: 'PHP' }).format(amount);
    };
    
    // --- TAB MANAGEMENT ---
    window.changeTab = (tabName) => {
        document.querySelectorAll('.tab-pane').forEach(pane => {
            pane.classList.add('hidden');
        });
        document.getElementById(tabName).classList.remove('hidden');

        document.querySelectorAll('.tab').forEach(tab => {
            tab.classList.remove('tab-active');
            tab.style.color = 'var(--text-secondary)';
            tab.style.borderColor = 'transparent';
        });
        const activeTab = document.querySelector(`.tab[data-tab="${tabName}"]`);
        activeTab.classList.add('tab-active');
        activeTab.style.color = 'var(--accent-primary)';
        activeTab.style.borderColor = 'var(--accent-primary)';

    };

    // --- RENDERING FUNCTIONS ---
    const renderAll = () => {
        renderDashboard();
        renderStockTable();
        renderSalesTable();
        renderStockLevels();
        renderTransfersInTable();
        renderTransfersOutTable();
    };

    const renderDashboard = () => {
        const totalSales = sales.reduce((sum, item) => sum + item.price, 0);
        const totalIncentives = sales.reduce((sum, item) => sum + item.incentive, 0);
        
        document.getElementById('dashboard-sales').textContent = formatCurrency(totalSales);
        document.getElementById('dashboard-stock').textContent = inventory.length;
        document.getElementById('dashboard-incentives').textContent = formatCurrency(totalIncentives);
    };
    
    const renderStockTable = () => {
        console.log('Rendering stock table with role:', currentUserRole); 
        
        const tableBody = document.getElementById('stock-table-body');
        tableBody.innerHTML = '';
        if (inventory.length === 0) {
            tableBody.innerHTML = `<tr><td colspan="8" class="text-center py-4" style="color: var(--text-secondary);">No items in stock.</td></tr>`;
            return;
        }
        inventory.forEach(item => {
            const canEdit = currentUserRole === 'admin' || currentUserRole === 'editor';
            const isAdmin = currentUserRole === 'admin';
            
            let actionsHtml = '';
            if (canEdit) {
                 actionsHtml += `<button data-itemid="${item.id}" data-type="inventory" class="edit-item-btn p-1 rounded-md hover:bg-blue-100 dark:hover:bg-blue-900/50" title="Edit Item">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 pointer-events-none" style="color: var(--accent-primary);" viewBox="0 0 20 20" fill="currentColor">
                            <path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" />
                            <path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" />
                        </svg>
                    </button>`;
            }
             if (isAdmin) {
                 actionsHtml += `<button data-itemid="${item.id}" data-type="inventory" class="delete-item-btn p-1 rounded-md hover:bg-red-100 dark:hover:bg-red-900/50 ml-2" title="Delete Item">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 pointer-events-none" style="color: var(--destructive);" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                        </svg>
                    </button>`;
            }

            const row = `
                <tr class="hover:bg-gray-50 dark:hover:bg-gray-700/50">
                    <td class="py-2 px-4 border-b" style="border-color: var(--border-primary);">${item.imei}</td>
                    <td class="py-2 px-4 border-b" style="border-color: var(--border-primary);">${item.brand}</td>
                    <td class="py-2 px-4 border-b" style="border-color: var(--border-primary);">${item.model}</td>
                    <td class="py-2 px-4 border-b" style="border-color: var(--border-primary);">${item.variant}</td>
                    <td class="py-2 px-4 border-b" style="border-color: var(--border-primary);">${item.color}</td>
                    <td class="py-2 px-4 border-b" style="border-color: var(--border-primary);">${formatCurrency(item.price)}</td>
                    <td class="py-2 px-4 border-b" style="border-color: var(--border-primary);">${item.notes}</td>
                    <td class="py-2 px-4 border-b text-center" style="border-color: var(--border-primary);">${actionsHtml}</td>
                </tr>
            `;
            tableBody.innerHTML += row;
        });
    };

    const renderSalesTable = () => {
        const tableBody = document.getElementById('sales-table-body');
        tableBody.innerHTML = '';
        if (sales.length === 0) {
            tableBody.innerHTML = `<tr><td colspan="6" class="text-center py-4" style="color: var(--text-secondary);">No sales recorded today.</td></tr>`;
            return;
        }
        sales.forEach(item => {
            const row = `
                <tr class="hover:bg-gray-50 dark:hover:bg-gray-700/50">
                    <td class="py-2 px-4 border-b" style="border-color: var(--border-primary);">${item.imei}</td>
                    <td class="py-2 px-4 border-b" style="border-color: var(--border-primary);">${item.brand}</td>
                    <td class="py-2 px-4 border-b" style="border-color: var(--border-primary);">${item.model}</td>
                    <td class="py-2 px-4 border-b" style="border-color: var(--border-primary);">${formatCurrency(item.price)}</td>
                    <td class="py-2 px-4 border-b" style="border-color: var(--border-primary);">${formatCurrency(item.incentive)}</td>
                    <td class="py-2 px-4 border-b" style="border-color: var(--border-primary);">${item.notes}</td>
                </tr>
            `;
            tableBody.innerHTML += row;
        });
    };
    
    const renderTransfersInTable = () => {
        const tableBody = document.getElementById('transfer-in-table-body');
        tableBody.innerHTML = '';
        if (transfersIn.length === 0) {
            tableBody.innerHTML = `<tr><td colspan="5" class="text-center py-4" style="color: var(--text-secondary);">No transfers in recorded today.</td></tr>`;
            return;
        }
        transfersIn.forEach(item => {
            const canEdit = currentUserRole === 'admin' || currentUserRole === 'editor';
            const isAdmin = currentUserRole === 'admin';
            let actionsHtml = '';
            if (canEdit) {
                 actionsHtml += `<button data-itemid="${item.id}" data-type="transfersIn" class="edit-item-btn p-1 rounded-md hover:bg-blue-100 dark:hover:bg-blue-900/50" title="Edit Item">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 pointer-events-none" style="color: var(--accent-primary);" viewBox="0 0 20 20" fill="currentColor">
                            <path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" />
                            <path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" />
                        </svg>
                    </button>`;
            }
            if (isAdmin) {
                actionsHtml += `<button data-itemid="${item.id}" data-type="transfersIn" class="delete-item-btn p-1 rounded-md hover:bg-red-100 dark:hover:bg-red-900/50 ml-2" title="Delete Item">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 pointer-events-none" style="color: var(--destructive);" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                        </svg>
                    </button>`;
            }

            const row = `
                <tr class="hover:bg-gray-50 dark:hover:bg-gray-700/50">
                    <td class="py-2 px-4 border-b" style="border-color: var(--border-primary);">${item.imei}</td>
                    <td class="py-2 px-4 border-b" style="border-color: var(--border-primary);">${item.brand}</td>
                    <td class="py-2 px-4 border-b" style="border-color: var(--border-primary);">${item.model}</td>
                    <td class="py-2 px-4 border-b" style="border-color: var(--border-primary);">${item.notes}</td>
                    <td class="py-2 px-4 border-b text-center" style="border-color: var(--border-primary);">${actionsHtml}</td>
                </tr>
            `;
            tableBody.innerHTML += row;
        });
    };

    const renderTransfersOutTable = () => {
        const tableBody = document.getElementById('transfer-out-table-body');
        tableBody.innerHTML = '';
        if (transfersOut.length === 0) {
            tableBody.innerHTML = `<tr><td colspan="5" class="text-center py-4" style="color: var(--text-secondary);">No transfers out recorded today.</td></tr>`;
            return;
        }
        transfersOut.forEach(item => {
            const canEdit = currentUserRole === 'admin' || currentUserRole === 'editor';
            const isAdmin = currentUserRole === 'admin';
            let actionsHtml = '';
            if (canEdit) {
                 actionsHtml += `<button data-itemid="${item.id}" data-type="transfersOut" class="edit-item-btn p-1 rounded-md hover:bg-blue-100 dark:hover:bg-blue-900/50" title="Edit Item">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 pointer-events-none" style="color: var(--accent-primary);" viewBox="0 0 20 20" fill="currentColor">
                            <path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" />
                            <path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" />
                        </svg>
                    </button>`;
            }
            if (isAdmin) {
                actionsHtml += `<button data-itemid="${item.id}" data-type="transfersOut" class="delete-item-btn p-1 rounded-md hover:bg-red-100 dark:hover:bg-red-900/50 ml-2" title="Delete Item">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 pointer-events-none" style="color: var(--destructive);" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                        </svg>
                    </button>`;
            }
            
            const row = `
                <tr class="hover:bg-gray-50 dark:hover:bg-gray-700/50">
                    <td class="py-2 px-4 border-b" style="border-color: var(--border-primary);">${item.imei}</td>
                    <td class="py-2 px-4 border-b" style="border-color: var(--border-primary);">${item.brand}</td>
                    <td class="py-2 px-4 border-b" style="border-color: var(--border-primary);">${item.model}</td>
                    <td class="py-2 px-4 border-b" style="border-color: var(--border-primary);">${item.notes}</td>
                    <td class="py-2 px-4 border-b text-center" style="border-color: var(--border-primary);">${actionsHtml}</td>
                </tr>
            `;
            tableBody.innerHTML += row;
        });
    };

    const renderStockLevels = () => {
        const highStockList = document.getElementById('high-stock-list');
        const lowStockList = document.getElementById('low-stock-list');
        highStockList.innerHTML = '';
        lowStockList.innerHTML = '';
        
        const stockCounts = inventory.reduce((acc, item) => {
            const key = `${item.brand} ${item.model} ${item.variant}`;
            acc[key] = (acc[key] || 0) + 1;
            return acc;
        }, {});
        
        const sortedStock = Object.entries(stockCounts).sort(([,a],[,b]) => b - a);
        
        if(sortedStock.length === 0) {
            highStockList.innerHTML = `<p style="color: var(--text-secondary);">No stock to analyze.</p>`;
            lowStockList.innerHTML = `<p style="color: var(--text-secondary);">No stock to analyze.</p>`;
            return;
        }

        const LOW_STOCK_THRESHOLD = 3;
        
        sortedStock.forEach(([name, count]) => {
            const itemHtml = `
                <div class="flex justify-between items-center p-2 rounded-md" style="background-color: var(--bg-tertiary);">
                    <span class="text-sm">${name}</span>
                    <span class="font-bold text-sm px-2 py-1 rounded-full ${count > LOW_STOCK_THRESHOLD ? 'bg-green-200 text-green-800 dark:bg-green-800 dark:text-green-200' : 'bg-red-200 text-red-800 dark:bg-red-800 dark:text-red-200'}">${count}</span>
                </div>`;

            if (count > LOW_STOCK_THRESHOLD) {
                highStockList.innerHTML += itemHtml;
            } else {
                lowStockList.innerHTML += itemHtml;
            }
        });

        if (highStockList.innerHTML === '') {
            highStockList.innerHTML = `<p style="color: var(--text-secondary);">No items with high stock levels.</p>`;
        }
        if (lowStockList.innerHTML === '') {
            lowStockList.innerHTML = `<p style="color: var(--text-secondary);">No items with low stock levels.</p>`;
        }
    };

    // --- Firestore Data Handling ---
    const setupListeners = (role) => {
        detachListeners();
        const today = new Date();
        today.setHours(0, 0, 0, 0);

        const inventoryRef = collection(db, "inventory");
        inventoryUnsubscribe = onSnapshot(inventoryRef, (snapshot) => {
            inventory = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            renderAll();
        });

        const salesQuery = query(collection(db, "sales"), where("soldAt", ">=", today));
        salesUnsubscribe = onSnapshot(salesQuery, (snapshot) => {
            sales = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            renderAll();
        });

        const transfersInQuery = query(collection(db, "transfersIn"), where("transferredAt", ">=", today));
        transfersInUnsubscribe = onSnapshot(transfersInQuery, (snapshot) => {
            transfersIn = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            renderAll();
        });

        const transfersOutQuery = query(collection(db, "transfersOut"), where("transferredAt", ">=", today));
        transfersOutUnsubscribe = onSnapshot(transfersOutQuery, (snapshot) => {
            transfersOut = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            renderAll();
        });

        if (role === 'admin') {
            setupAdminListeners();
        }
    }
    
    const setupAdminListeners = () => {
        const usersRef = collection(db, 'users');
        usersUnsubscribe = onSnapshot(usersRef, (snapshot) => {
            const users = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            renderUserManagementTable(users);
        });
    };

    const detachListeners = () => {
        if (inventoryUnsubscribe) inventoryUnsubscribe();
        if (salesUnsubscribe) salesUnsubscribe();
        if (transfersInUnsubscribe) transfersInUnsubscribe();
        if (transfersOutUnsubscribe) transfersOutUnsubscribe();
        if (usersUnsubscribe) usersUnsubscribe();
    }

    const renderUserManagementTable = (users) => {
        const tableBody = document.getElementById('user-management-table-body');
        tableBody.innerHTML = '';
        const currentUserId = auth.currentUser.uid;

        users.forEach(user => {
            const isCurrentUser = user.id === currentUserId;
            const row = document.createElement('tr');
            row.innerHTML = `
                <td class="py-2 px-4 border-b" style="border-color: var(--border-primary);">${user.email}</td>
                <td class="py-2 px-4 border-b" style="border-color: var(--border-primary);">${user.role}</td>
                <td class="py-2 px-4 border-b" style="border-color: var(--border-primary);">
                    ${!isCurrentUser ? `
                    <select class="form-select p-2 border rounded-md" data-userid="${user.id}">
                        <option value="viewer" ${user.role === 'viewer' ? 'selected' : ''}>Viewer</option>
                        <option value="editor" ${user.role === 'editor' ? 'selected' : ''}>Editor</option>
                        <option value="admin" ${user.role === 'admin' ? 'selected' : ''}>Admin</option>
                    </select>
                    ` : 'Cannot change own role'}
                </td>
            `;
            tableBody.appendChild(row);
        });

        // Add event listeners after rendering
        tableBody.querySelectorAll('select').forEach(select => {
            select.addEventListener('change', async (e) => {
                const newRole = e.target.value;
                const userIdToUpdate = e.target.dataset.userid;
                try {
                    const userDocRef = doc(db, 'users', userIdToUpdate);
                    await updateDoc(userDocRef, { role: newRole });
                    showToast(`User role updated to ${newRole}`, 'success');
                } catch (error) {
                    console.error("Error updating role: ", error);
                    showToast('Failed to update role.', 'error');
                }
            });
        });
    };
    
    // --- AUTHENTICATION & ROLE MANAGEMENT ---
    
    const initializeUserSession = (role, email) => {
        currentUserRole = role; // Set the role first
        authContainer.classList.add('hidden');
        appContainer.classList.remove('hidden');
        document.getElementById('user-email').textContent = email;
        updateUIAfterLogin(role); // Update UI elements like badges
        setupListeners(role);    // THEN set up data listeners
    };

    const cleanupSession = () => {
        authContainer.classList.remove('hidden');
        appContainer.classList.add('hidden');
        detachListeners();
        // Explicitly clear data and role to prevent state leakage
        inventory = [];
        sales = [];
        transfersIn = [];
        transfersOut = [];
        currentUserRole = null;
    };

    onAuthStateChanged(auth, async (user) => {
        if(user) {
            const userDocRef = doc(db, 'users', user.uid);
            const userDoc = await getDoc(userDocRef);

            if (userDoc.exists()) {
                const userData = userDoc.data();
                initializeUserSession(userData.role, userData.email);
            } else {
                const usersRef = collection(db, 'users');
                const q = query(usersRef, limit(1));
                const existingUsers = await getDocs(q);
                const isFirstUser = existingUsers.empty;
                const newUserRole = isFirstUser ? 'admin' : 'viewer';

                try {
                    await setDoc(userDocRef, {
                        email: user.email,
                        role: newUserRole,
                        createdAt: serverTimestamp()
                    });
                    initializeUserSession(newUserRole, user.email);
                } catch (error) {
                    console.error("Error creating user document:", error);
                    authError.textContent = "Could not create user profile. Please try again.";
                    authError.style.display = 'block';
                    signOut(auth);
                }
            }
        } else {
            cleanupSession();
        }
    });

    const updateUIAfterLogin = (role) => {
        const roleBadge = document.getElementById('user-role-badge');
        roleBadge.textContent = role;
        roleBadge.className = 'text-xs font-semibold px-2 py-1 rounded-full'; // reset classes
        
        const adminTab = document.getElementById('admin-tab-btn');
        const viewOnlyBanner = document.getElementById('view-only-banner');
        const forms = document.querySelectorAll('form');

        if (role === 'admin' || role === 'editor') {
            viewOnlyBanner.classList.add('hidden');
            forms.forEach(f => f.querySelectorAll('input, button, textarea').forEach(el => el.disabled = false));
            if (role === 'admin') {
                roleBadge.classList.add('bg-purple-200', 'text-purple-800');
                adminTab.classList.remove('hidden');
            } else {
                 roleBadge.classList.add('bg-blue-200', 'text-blue-800');
                adminTab.classList.add('hidden');
            }
        } else { // viewer
            roleBadge.classList.add('bg-gray-200', 'text-gray-800');
            adminTab.classList.add('hidden');
            viewOnlyBanner.classList.remove('hidden');
            forms.forEach(f => f.querySelectorAll('input, button, textarea').forEach(el => el.disabled = true));
        }
    };
    
    signupBtn.addEventListener('click', async () => {
        const email = document.getElementById('signup-email').value;
        const password = document.getElementById('signup-password').value;
        authError.style.display = 'none';

        try {
            await createUserWithEmailAndPassword(auth, email, password);
            showToast('Account created successfully!', 'success');
        } catch (error) {
            authError.textContent = error.message;
            authError.style.display = 'block';
        }
    });

    signinBtn.addEventListener('click', async () => {
        const email = document.getElementById('signin-email').value;
        const password = document.getElementById('signin-password').value;
        authError.style.display = 'none';

        signinBtn.disabled = true;
        signinBtn.textContent = 'Signing In...';

        try {
            await signInWithEmailAndPassword(auth, email, password);
        } catch (error) {
            console.error('Sign-in error:', error);
            if (error.code === 'auth/invalid-credential') {
                authError.textContent = 'Incorrect email or password. Please try again.';
            } else {
                authError.textContent = error.message;
            }
            authError.style.display = 'block';
        } finally {
            signinBtn.disabled = false;
            signinBtn.textContent = 'Sign In';
        }
    });

    signoutBtn.addEventListener('click', () => {
        signOut(auth);
    });

    // --- FORM SUBMISSIONS ---
    document.getElementById('delivery-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const imei = document.getElementById('del-imei').value.trim();
        if(imei.length !== 15 || !/^\d+$/.test(imei)) {
            showToast('IMEI must be 15 digits.', 'error');
            return;
        }
        
        const inventoryRef = collection(db, 'inventory');
        const q = query(inventoryRef, where("imei", "==", imei), limit(1));
        const existing = await getDocs(q);
        if(!existing.empty){
            showToast('This IMEI already exists in stock.', 'error');
            return;
        }

        const newItem = {
            imei: imei,
            brand: document.getElementById('del-brand').value.trim(),
            model: document.getElementById('del-model').value.trim(),
            variant: document.getElementById('del-variant').value.trim(),
            color: document.getElementById('del-color').value.trim(),
            price: parseFloat(document.getElementById('del-price').value),
            notes: document.getElementById('del-notes').value.trim(),
            addedAt: serverTimestamp()
        };
        
        try {
            await addDoc(inventoryRef, newItem);
            e.target.reset();
            showToast('Item added to stock successfully!');
        } catch (error) {
            console.error("Error adding document: ", error);
            showToast('Failed to add item.', 'error');
        }
    });
    
    document.getElementById('sales-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const imei = document.getElementById('sale-imei').value.trim();
        
        const inventoryRef = collection(db, `inventory`);
        const q = query(inventoryRef, where("imei", "==", imei), limit(1));
        const snapshot = await getDocs(q);

        if (snapshot.empty) {
            showToast('Item with this IMEI not found in stock.', 'error');
            return;
        }
        
        const stockDoc = snapshot.docs[0];
        const soldItemData = stockDoc.data();
        
        const newSale = {
            ...soldItemData,
            incentive: parseFloat(document.getElementById('sale-incentive').value) || 0,
            notes: document.getElementById('sale-notes').value.trim(),
            soldAt: serverTimestamp()
        };

        try {
            await runTransaction(db, async (transaction) => {
                transaction.delete(stockDoc.ref);
                transaction.set(doc(collection(db, 'sales')), newSale);
            });
            e.target.reset();
            showToast('Sale recorded successfully!');
        } catch (error) {
            console.error("Transaction failed: ", error);
            showToast('Failed to record sale.', 'error');
        }
    });

    document.getElementById('transfer-in-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const imei = document.getElementById('tin-imei').value.trim();
        if(imei.length !== 15 || !/^\d+$/.test(imei)) {
            showToast('IMEI must be 15 digits.', 'error');
            return;
        }
        
        const inventoryRef = collection(db, 'inventory');
        const q = query(inventoryRef, where("imei", "==", imei), limit(1));
        const existing = await getDocs(q);
        if(!existing.empty){
            showToast('This IMEI already exists in stock.', 'error');
            return;
        }

        const newItem = {
            imei: imei,
            brand: document.getElementById('tin-brand').value.trim(),
            model: document.getElementById('tin-model').value.trim(),
            variant: document.getElementById('tin-variant').value.trim(),
            color: document.getElementById('tin-color').value.trim(),
            price: parseFloat(document.getElementById('tin-price').value),
            notes: document.getElementById('tin-notes').value.trim(),
            transferredAt: serverTimestamp()
        };
        
        try {
            await runTransaction(db, async (transaction) => {
                transaction.set(doc(collection(db, 'inventory')), newItem);
                transaction.set(doc(collection(db, 'transfersIn')), newItem);
            });
            e.target.reset();
            showToast('Item transferred in successfully!');
        } catch (error) {
            console.error("Error transferring item in: ", error);
            showToast('Failed to transfer item in.', 'error');
        }
    });

    document.getElementById('transfer-out-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const imei = document.getElementById('tout-imei').value.trim();
        if (!imei) {
            showToast('Please enter an IMEI to transfer out.', 'error');
            return;
        }

        const inventoryRef = collection(db, 'inventory');
        const q = query(inventoryRef, where("imei", "==", imei), limit(1));
        const snapshot = await getDocs(q);

        if (snapshot.empty) {
            showToast('Item with this IMEI not found in stock.', 'error');
            return;
        }

        const itemDoc = snapshot.docs[0];
        const itemData = itemDoc.data();
        const transferOutData = {
            ...itemData,
            notes: document.getElementById('tout-notes').value.trim(),
            transferredAt: serverTimestamp()
        };

        showConfirm(`Are you sure you want to transfer out item with IMEI ${imei}?`, async () => {
            try {
                 await runTransaction(db, async (transaction) => {
                    transaction.delete(itemDoc.ref);
                    transaction.set(doc(collection(db, 'transfersOut')), transferOutData);
                });
                showToast('Item transferred out successfully.', 'success');
                e.target.reset();
            } catch (error) {
                console.error("Error transferring item out:", error);
                showToast('Failed to transfer item out.', 'error');
            }
        }, { title: 'Confirm Transfer Out', okText: 'Transfer' });
    });


    // --- UI TOGGLES AND MODALS ---
    showSignupBtn.addEventListener('click', () => {
        signinForm.classList.add('hidden');
        signupForm.classList.remove('hidden');
        authError.style.display = 'none';
    });

    showSigninBtn.addEventListener('click', () => {
        signupForm.classList.add('hidden');
        signinForm.classList.remove('hidden');
        authError.style.display = 'none';
    });

    const openEditModal = (item, type) => {
        editModalTitle.textContent = `Edit ${type.charAt(0).toUpperCase() + type.slice(1)} Record`;
        editItemForm.elements['edit-item-id'].value = item.id;
        editItemForm.elements['edit-item-type'].value = type;
        editItemForm.elements['edit-imei'].value = item.imei;
        editItemForm.elements['edit-brand'].value = item.brand;
        editItemForm.elements['edit-model'].value = item.model;
        editItemForm.elements['edit-variant'].value = item.variant || '';
        editItemForm.elements['edit-color'].value = item.color || '';
        editItemForm.elements['edit-price'].value = item.price;
        editItemForm.elements['edit-notes'].value = item.notes;
        editItemModal.classList.remove('hidden');
    };

    const closeEditModal = () => {
        editItemModal.classList.add('hidden');
        editItemForm.reset();
    };

    editModalCloseBtn.addEventListener('click', closeEditModal);
    editModalCancelBtn.addEventListener('click', closeEditModal);

    editItemForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const itemId = e.target.elements['edit-item-id'].value;
        const itemType = e.target.elements['edit-item-type'].value;

        const updatedData = {
            brand: e.target.elements['edit-brand'].value.trim(),
            model: e.target.elements['edit-model'].value.trim(),
            variant: e.target.elements['edit-variant'].value.trim(),
            color: e.target.elements['edit-color'].value.trim(),
            price: parseFloat(e.target.elements['edit-price'].value),
            notes: e.target.elements['edit-notes'].value.trim()
        };

        try {
            const itemRef = doc(db, itemType, itemId);
            await updateDoc(itemRef, updatedData);
            showToast('Record updated successfully.', 'success');
            closeEditModal();
        } catch (error) {
            console.error("Error updating record:", error);
            showToast('Failed to update record.', 'error');
        }
    });

    // --- INITIALIZATION ---
    document.addEventListener('DOMContentLoaded', () => {
        darkModeToggle.addEventListener("change", (e) => applyDarkMode(e.target.checked));
        changeTab('dashboard');

        // Generic event listener for action buttons
        document.getElementById('tab-content').addEventListener('click', async (e) => {
            const editBtn = e.target.closest('.edit-item-btn');
            const deleteBtn = e.target.closest('.delete-item-btn');

            if (editBtn) {
                const itemId = editBtn.dataset.itemid;
                const itemType = editBtn.dataset.type;
                let item;
                if(itemType === 'inventory') item = inventory.find(i => i.id === itemId);
                if(itemType === 'transfersIn') item = transfersIn.find(i => i.id === itemId);
                if(itemType === 'transfersOut') item = transfersOut.find(i => i.id === itemId);
                
                if (item) {
                    openEditModal(item, itemType);
                }
            }
            
            if (deleteBtn) {
                const itemId = deleteBtn.dataset.itemid;
                const itemType = deleteBtn.dataset.type;
                 showConfirm(`Are you sure you want to permanently delete this record? This action cannot be undone.`, async () => {
                    try {
                        const itemRef = doc(db, itemType, itemId);
                        await deleteDoc(itemRef);
                        showToast('Record deleted successfully.', 'success');
                    } catch (error) {
                        console.error("Error deleting record:", error);
                        showToast('Failed to delete record.', 'error');
                    }
                }, { title: 'Confirm Deletion', okText: 'Delete' });
            }
        });
    });
</script>

</body>
</html>

