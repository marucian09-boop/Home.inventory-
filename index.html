<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daily Sales & Inventory</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Barcode Scanner Library -->
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --font-sans: 'Inter', sans-serif;
            /* Light Theme Colors */
            --bg-primary: #f3f4f6; /* gray-100 */
            --bg-secondary: #ffffff; /* white */
            --bg-tertiary: #f9fafb; /* gray-50 */
            --border-primary: #e5e7eb; /* gray-200 */
            --text-primary: #111827; /* gray-900 */
            --text-secondary: #6b7280; /* gray-500 */
            --accent-primary: #3b82f6; /* blue-500 */
            --accent-primary-hover: #2563eb; /* blue-600 */
            --destructive: #ef4444; /* red-500 */
            --destructive-hover: #dc2626; /* red-600 */
            --success: #22c55e; /* green-500 */
            --success-hover: #16a34a; /* green-600 */
            --special: #a855f7; /* purple-500 */
            --special-hover: #9333ea; /* purple-600 */
            
            --info-bg: #eff6ff; /* blue-50 */
            --info-text: #1e3a8a; /* blue-900 */
            --success-card-bg: #f0fdf4; /* green-50 */
            --success-card-text: #14532d; /* green-900 */
            --warning-bg: #fefce8; /* yellow-50 */
            --warning-text: #713f12; /* yellow-900 */

            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }

        .dark {
            /* Dark Theme Colors */
            --bg-primary: #111827; /* gray-900 */
            --bg-secondary: #1f2937; /* gray-800 */
            --bg-tertiary: #374151; /* gray-700 */
            --border-primary: #4b5563; /* gray-600 */
            --text-primary: #f9fafb; /* gray-50 */
            --text-secondary: #9ca3af; /* gray-400 */
            --accent-primary: #60a5fa; /* blue-400 */
            --accent-primary-hover: #3b82f6; /* blue-500 */
            --destructive: #f87171; /* red-400 */
            --destructive-hover: #ef4444; /* red-500 */
            --success: #4ade80; /* green-400 */
            --success-hover: #22c55e; /* green-500 */
            --special: #c084fc; /* purple-400 */
            --special-hover: #a855f7; /* purple-500 */

            --info-bg: #1e2937; 
            --info-text: #93c5fd; 
            --success-card-bg: #1e2937; 
            --success-card-text: #86efac;
            --warning-bg: #1e2937;
            --warning-text: #fde047;
        }

        body {
            font-family: var(--font-sans);
            background-color: var(--bg-primary);
            color: var(--text-primary);
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        .tab-active {
            border-bottom-color: var(--accent-primary);
            color: var(--accent-primary);
            font-weight: 600;
        }
        .table-container {
            max-height: 60vh;
            overflow-y: auto;
        }
        .form-input, .form-select {
            transition: all 0.3s ease;
            background-color: var(--bg-primary);
            border-color: var(--border-primary);
        }
        .form-input:focus, .form-select:focus {
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 2px color-mix(in srgb, var(--accent-primary) 20%, transparent);
            outline: none;
        }
        .form-input::placeholder {
            color: var(--text-secondary);
        }

        /* Toggle Switch */
        .switch { position: relative; display: inline-block; width: 44px; height: 24px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: var(--bg-tertiary); transition: .4s; border-radius: 24px; }
        .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--accent-primary); }
        input:checked + .slider:before { transform: translateX(20px); }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg-primary); }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }

        .row-highlight {
            animation: highlight-animation 2s ease-out;
        }

        @keyframes highlight-animation {
            0% { background-color: color-mix(in srgb, var(--accent-primary) 30%, transparent); }
            100% { background-color: transparent; }
        }

        /* Responsive Table Styles */
        @media screen and (max-width: 768px) {
            .responsive-table thead {
                display: none;
            }
            .responsive-table tr {
                display: block;
                margin-bottom: 1rem;
                border: 1px solid var(--border-primary);
                border-radius: 0.5rem;
                padding: 1rem;
                box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            }
            .dark .responsive-table tr {
                box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            }
            .responsive-table td {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 0.5rem 0;
                border-bottom: 1px solid var(--border-primary);
                text-align: right;
                font-size: 0.875rem;
            }
            .responsive-table td:last-child {
                border-bottom: 0;
                padding-bottom: 0;
            }
             .responsive-table td:first-child {
                padding-top: 0;
            }
            .responsive-table td::before {
                content: attr(data-label);
                font-weight: 600;
                text-align: left;
                margin-right: 1rem;
                color: var(--text-primary);
            }
            .responsive-table td[data-label="Actions"],
            .responsive-table td[data-label="Manage"] {
                justify-content: flex-end;
                padding-top: 0.75rem;
            }
        }
    </style>
</head>
<body class="antialiased">

    <!-- Auth Container -->
    <div id="auth-container" class="min-h-screen flex items-center justify-center p-4">
        <div class="max-w-md w-full space-y-8 p-8 sm:p-10 rounded-xl shadow-lg" style="background-color: var(--bg-secondary);">
            <div>
                <h2 class="mt-6 text-center text-3xl font-extrabold" style="color: var(--text-primary);">
                    Sign in or create an account
                </h2>
            </div>
            <div id="auth-error" class="text-center p-2 rounded-md" style="color: var(--destructive); display: none;"></div>
            <!-- Auth Forms -->
            <div id="signin-form">
                <input type="email" id="signin-email" placeholder="Email address" class="form-input w-full p-2 border rounded-md mb-4">
                <input type="password" id="signin-password" placeholder="Password" class="form-input w-full p-2 border rounded-md mb-4">
                <button id="signin-btn" style="background-color: var(--accent-primary);" class="w-full text-white font-semibold py-2 px-4 rounded-md transition-colors disabled:opacity-50">Sign In</button>
                <p class="mt-4 text-center text-sm" style="color: var(--text-secondary);">
                    No account? <button id="show-signup-btn" class="font-medium hover:underline" style="color: var(--accent-primary);">Sign up</button>
                </p>
            </div>
            <div id="signup-form" class="hidden">
                 <input type="email" id="signup-email" placeholder="Email address" class="form-input w-full p-2 border rounded-md mb-4">
                <input type="password" id="signup-password" placeholder="Password" class="form-input w-full p-2 border rounded-md mb-4">
                <button id="signup-btn" style="background-color: var(--success);" class="w-full text-white font-semibold py-2 px-4 rounded-md transition-colors">Create Account</button>
                <p class="mt-4 text-center text-sm" style="color: var(--text-secondary);">
                    Already have an account? <button id="show-signin-btn" class="font-medium hover:underline" style="color: var(--accent-primary);">Sign in</button>
                </p>
            </div>
        </div>
    </div>


    <!-- App Container -->
    <div id="app-container" class="hidden container mx-auto p-2 sm:p-6 lg:p-8">
        <header class="mb-4 flex flex-col sm:flex-row justify-between items-center gap-4">
            <div>
                <h1 class="text-2xl sm:text-3xl font-bold text-center sm:text-left" style="color: var(--text-primary);">Inventory Dashboard</h1>
                <div id="user-info" class="flex items-center justify-center sm:justify-start gap-4 mt-2">
                    <p style="color: var(--text-secondary);" id="user-email" class="text-sm"></p>
                    <span id="user-role-badge" class="text-xs font-semibold px-2 py-1 rounded-full"></span>
                    <button id="signout-btn" style="background-color: var(--destructive);" class="text-white text-xs font-semibold py-1 px-3 rounded-md transition-colors">Sign Out</button>
                </div>
            </div>
            <div class="flex items-center space-x-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="color: var(--text-secondary);">
                    <path d="M3 7h18M3 12h18M3 17h18" />
                </svg>
                <label class="switch">
                    <input type="checkbox" id="darkModeToggle">
                    <span class="slider"></span>
                </label>
            </div>
        </header>
        
        <div id="view-only-banner" class="hidden mb-4 p-4 rounded-md text-center" style="background-color: var(--warning-bg); color: var(--warning-text);">
            You have view-only access.
        </div>

        <!-- Main Content -->
        <div style="background-color: var(--bg-secondary); box-shadow: var(--shadow-lg);" class="rounded-xl p-2 sm:p-6">
            <!-- Date Filter & Daily Report -->
            <div class="flex flex-wrap items-center gap-4 mb-4 pb-4 border-b" style="border-color: var(--border-primary);">
                 <label for="date-filter" class="font-semibold text-sm">Showing data for:</label>
                 <input type="date" id="date-filter" class="form-input p-2 border rounded-md">
                 <button id="goto-today-btn" class="text-sm font-semibold py-2 px-4 rounded-md" style="background-color: var(--bg-tertiary);">Today</button>
                 <button id="download-report-btn" class="text-sm font-semibold py-2 px-4 rounded-md" style="background-color: var(--accent-primary); color: white;">Download Daily Report</button>
            </div>

            <!-- Tabs -->
            <div style="border-color: var(--border-primary);" class="border-b mb-6">
                <nav id="tabs-nav" class="-mb-px flex space-x-6 overflow-x-auto" aria-label="Tabs">
                    <button onclick="changeTab('dashboard')" class="tab whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm tab-active" data-tab="dashboard">Dashboard</button>
                    <button onclick="changeTab('deliveries')" class="tab whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm" data-tab="deliveries">Deliveries</button>
                    <button onclick="changeTab('stocks')" class="tab whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm" data-tab="stocks">Stocks</button>
                    <button onclick="changeTab('sales')" class="tab whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm" data-tab="sales">Sales</button>
                    <button onclick="changeTab('accessories')" class="tab whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm" data-tab="accessories">Accessories</button>
                    <button onclick="changeTab('accessoriesSellOut')" class="tab whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm" data-tab="accessoriesSellOut">Accessories Sell Out</button>
                    <button onclick="changeTab('transferOut')" class="tab whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm" data-tab="transferOut">Transfer Out</button>
                    <button onclick="changeTab('transferIn')" class="tab whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm" data-tab="transferIn">Transfer In</button>
                    <button onclick="changeTab('stockLevel')" class="tab whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm" data-tab="stockLevel">Stock Level</button>
                    <button id="admin-tab-btn" onclick="changeTab('admin')" class="tab hidden whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm" data-tab="admin">Admin</button>
                </nav>
            </div>

            <!-- Tab Content -->
            <div id="tab-content">
                <!-- Dashboard -->
                <div id="dashboard" class="tab-pane">
                    <!-- Search Section -->
                    <div id="search-section" class="mb-6">
                        <h2 class="text-xl font-semibold mb-4">System-Wide Search</h2>
                        <div class="flex flex-col sm:flex-row gap-2">
                            <input type="text" id="search-input" placeholder="Search by IMEI..." class="form-input flex-grow" maxlength="15" required>
                            <button id="search-btn" style="background-color: var(--accent-primary);" class="text-white font-semibold py-2 px-6 rounded-md transition-colors">Search</button>
                        </div>
                        <div id="search-results-container" class="mt-4">
                            <!-- Search results will be injected here -->
                        </div>
                    </div>
                    
                    <div class="border-t pt-6" style="border-color: var(--border-primary);">
                          <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div style="background-color: var(--info-bg); color: var(--info-text);" class="p-6 rounded-lg">
                                <h3 class="font-semibold text-lg" id="dashboard-sales-title">Sales for Today</h3>
                                <p class="text-3xl font-bold mt-2" id="dashboard-sales">₱0.00</p>
                            </div>
                            <div style="background-color: var(--success-card-bg); color: var(--success-card-text);" class="p-6 rounded-lg">
                                <h3 class="font-semibold text-lg">Total Stock Items</h3>
                                <p class="text-3xl font-bold mt-2" id="dashboard-stock">0</p>
                            </div>
                            <div style="background-color: var(--warning-bg); color: var(--warning-text);" class="p-6 rounded-lg">
                                <h3 class="font-semibold text-lg" id="dashboard-incentives-title">Incentives for Today</h3>
                                <p class="text-3xl font-bold mt-2" id="dashboard-incentives">₱0.00</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Deliveries -->
                <div id="deliveries" class="tab-pane hidden">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-semibold">Add New Delivery</h2>
                        <button class="download-btn text-sm font-semibold py-2 px-4 rounded-md" data-type="deliveries" style="background-color: var(--bg-tertiary);">Download CSV</button>
                    </div>
                    <form id="delivery-form" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <div class="relative flex items-center">
                            <input type="text" id="del-imei" placeholder="15-Digit IMEI" class="form-input w-full p-2 border rounded-md pr-24" maxlength="15" required>
                            <div class="absolute inset-y-0 right-0 flex items-center">
                                <button type="button" id="lookup-imei-btn" class="px-2 text-sm font-semibold hidden" style="color: var(--accent-primary);" title="Look up IMEI details">Lookup</button>
                                <button type="button" id="scan-imei-btn" class="flex items-center px-3 h-full rounded-r-md" style="background-color: var(--accent-primary); color: white;" title="Scan IMEI with Camera">
                                    <svg class="w-6 h-6 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 6h9.75M10.5 6a1.5 1.5 0 11-3 0m3 0a1.5 1.5 0 10-3 0M3.75 6H7.5m3 12h9.75m-9.75 0a1.5 1.5 0 01-3 0m3 0a1.5 1.5 0 10-3 0M3.75 18H7.5"/>
                                    </svg>
                                </button>
                            </div>
                        </div>
                        <input type="text" id="del-brand" placeholder="Brand" class="form-input w-full p-2 border rounded-md" required>
                        <input type="text" id="del-model" placeholder="Model" class="form-input w-full p-2 border rounded-md" required>
                        <input type="text" id="del-variant" placeholder="Variant (e.g., 128GB)" class="form-input w-full p-2 border rounded-md">
                        <input type="text" id="del-color" placeholder="Color" class="form-input w-full p-2 border rounded-md">
                        <input type="number" id="del-price" placeholder="Price" class="form-input w-full p-2 border rounded-md" required>
                        <input type="text" id="del-notes" placeholder="Notes" class="form-input md:col-span-2 lg:col-span-1 w-full p-2 border rounded-md">
                        <button type="submit" style="background-color: var(--accent-primary);" class="md:col-span-2 lg:col-span-3 text-white font-semibold py-2 px-4 rounded-md transition-colors">Add to Deliveries</button>
                    </form>
                    <div class="flex flex-wrap justify-between items-center mt-8 mb-4 gap-4">
                        <h3 class="text-lg font-semibold" id="deliveries-title">Today's Deliveries</h3>
                        <div class="flex items-center gap-2">
                              <label for="deliveries-sort" class="text-sm font-medium">Sort by:</label>
                              <select id="deliveries-sort" class="sort-select form-select p-2 border rounded-md text-sm" data-type="deliveries">
                                  <option value="latest">Latest First</option>
                                  <option value="alphabetical">Brand (A-Z)</option>
                              </select>
                        </div>
                    </div>
                     <div class="table-container">
                        <table class="min-w-full responsive-table">
                            <thead>
                                <tr>
                                    <th class="py-2 px-4 border-b text-left" style="border-color: var(--border-primary);">IMEI</th>
                                    <th class="py-2 px-4 border-b text-left" style="border-color: var(--border-primary);">Brand</th>
                                    <th class="py-2 px-4 border-b text-left" style="border-color: var(--border-primary);">Model</th>
                                    <th class="py-2 px-4 border-b text-left" style="border-color: var(--border-primary);">Variant</th>
                                    <th class="py-2 px-4 border-b text-left" style="border-color: var(--border-primary);">Date</th>
                                    <th class="py-2 px-4 border-b text-left" style="border-color: var(--border-primary);">Author</th>
                                    <th class="py-2 px-4 border-b text-center" style="border-color: var(--border-primary);">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="deliveries-table-body"></tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Stocks -->
                <div id="stocks" class="tab-pane hidden">
                     <div class="flex flex-wrap justify-between items-center mb-4 gap-4">
                        <h2 class="text-xl font-semibold">Current Stock</h2>
                        <div class="flex items-center gap-4">
                            <div class="flex items-center gap-2">
                                <label for="stocks-sort" class="text-sm font-medium">Sort by:</label>
                                 <select id="stocks-sort" class="sort-select form-select p-2 border rounded-md text-sm" data-type="inventory">
                                     <option value="latest">Latest First</option>
                                     <option value="alphabetical">Brand (A-Z)</option>
                                 </select>
                            </div>
                            <button class="download-btn text-sm font-semibold py-2 px-4 rounded-md" data-type="inventory" style="background-color: var(--bg-tertiary);">Download CSV</button>
                        </div>
                    </div>
                    <div class="table-container">
                        <table class="min-w-full responsive-table">
                            <thead>
                                <tr>
                                    <th class="py-2 px-4 border-b text-left" style="border-color: var(--border-primary);">IMEI</th>
                                    <th class="py-2 px-4 border-b text-left" style="border-color: var(--border-primary);">Brand</th>
                                    <th class="py-2 px-4 border-b text-left" style="border-color: var(--border-primary);">Model</th>
                                    <th class="py-2 px-4 border-b text-left" style="border-color: var(--border-primary);">Variant</th>
                                    <th class="py-2 px-4 border-b text-left" style="border-color: var(--border-primary);">Date Added</th>
                                    <th class="py-2 px-4 border-b text-left" style="border-color: var(--border-primary);">Author</th>
                                    <th class="py-2 px-4 border-b text-center" style="border-color: var(--border-primary);">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="stock-table-body"></tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Sales Today -->
                <div id="sales" class="tab-pane hidden">
                    <h2 class="text-xl font-semibold mb-4">Record a Sale</h2>
                    <form id="sales-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <input type="text" id="sale-imei" placeholder="15-Digit IMEI of sold item" class="form-input w-full p-2 border rounded-md" maxlength="15" required>
                        <input type="number" id="sale-incentive" placeholder="Incentive" class="form-input w-full p-2 border rounded-md" required>
                        <select id="sale-payment" class="form-select w-full p-2 border rounded-md" required>
                            <option value="" disabled selected>Payment Option</option>
                            <option value="Cash">Cash</option>
                            <option value="Credit Card">Credit Card</option>
                            <option value="Digital Wallet">Digital Wallet</option>
                            <option value="Bank Transfer">Bank Transfer</option>
                            <option value="Others">Others</option>
                        </select>
                        <input type="text" id="sale-receipt-number" placeholder="Order Receipt #" class="form-input w-full p-2 border rounded-md">
                        <input type="text" id="sale-notes" placeholder="Notes" class="form-input w-full p-2 border rounded-md md:col-span-full">
                        <button type="submit" style="background-color: var(--success);" class="md:col-span-full text-white font-semibold py-2 px-4 rounded-md transition-colors">Record Sale</button>
                    </form>
                    <div class="flex flex-wrap justify-between items-center mt-8 mb-4 gap-4">
                        <h3 class="text-lg font-semibold" id="sales-title">Today's Sales</h3>
                        <div class="flex items-center gap-4">
                             <div class="flex items-center gap-2">
                                <label for="sales-sort" class="text-sm font-medium">Sort by:</label>
                                 <select id="sales-sort" class="sort-select form-select p-2 border rounded-md text-sm" data-type="sales">
                                     <option value="latest">Latest First</option>
                                     <option value="alphabetical">Brand (A-Z)</option>
                                 </select>
                            </div>
                            <div class="flex items-center gap-2">
                                <label for="sales-payment-filter" class="text-sm font-medium">Filter by:</label>
                                 <select id="sales-payment-filter" class="form-select p-2 border rounded-md text-sm">
                                     <option value="all">All Payments</option>
                                     <option value="Cash">Cash</option>
                                     <option value="Credit Card">Credit Card</option>
                                     <option value="Digital Wallet">Digital Wallet</option>
                                     <option value="Bank Transfer">Bank Transfer</option>
                                     <option value="Others">Others</option>
                                 </select>
                            </div>
                            <button class="download-btn text-sm font-semibold py-2 px-4 rounded-md" data-type="sales" style="background-color: var(--bg-tertiary);">Download CSV</button>
                        </div>
                    </div>
                     <div class="table-container">
                        <table class="min-w-full responsive-table">
                            <thead>
                                <tr>
                                    <th class="py-2 px-4 border-b text-left" style="border-color: var(--border-primary);">IMEI</th>
                                    <th class="py-2 px-4 border-b text-left" style="border-color: var(--border-primary);">Brand</th>
                                    <th class="py-2 px-4 border-b text-left" style="border-color: var(--border-primary);">Model</th>
                                    <th class="py-2 px-4 border-b text-left" style="border-color: var(--border-primary);">Variant</th>
                                    <th class="py-2 px-4 border-b text-left" style="border-color: var(--border-primary);">Date</th>
                                    <th class="py-2 px-4 border-b text-left" style="border-color: var(--border-primary);">Payment</th>
                                    <th class="py-2 px-4 border-b text-left" style="border-color: var(--border-primary);">Receipt #</th>
                                    <th class="py-2 px-4 border-b text-left" style="border-color: var(--border-primary);">Author</th>
                                    <th class="py-2 px-4 border-b text-center" style="border-color: var(--border-primary);">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="sales-table-body"></tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Accessories -->
                <div id="accessories" class="tab-pane hidden">
                    <h2 class="text-xl font-semibold mb-4">Add New Accessory</h2>
                    <form id="accessory-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <input type="text" id="acc-brand" placeholder="Brand" class="form-input w-full p-2 border rounded-md" required>
                        <input type="text" id="acc-model" placeholder="Model" class="form-input w-full p-2 border rounded-md" required>
                        <input type="text" id="acc-variant" placeholder="Variant (e.g., Color, Size)" class="form-input w-full p-2 border rounded-md">
                        <select id="acc-type" class="form-select w-full p-2 border rounded-md" required>
                            <option value="" disabled selected>Accessory Type</option>
                            <option value="For Sale">For Sale</option>
                            <option value="Freebie">Freebie</option>
                        </select>
                        <input type="number" id="acc-price" placeholder="Price" class="form-input w-full p-2 border rounded-md" required>
                        <button type="submit" style="background-color: var(--accent-primary);" class="md:col-span-full text-white font-semibold py-2 px-4 rounded-md transition-colors">Add Accessory</button>
                    </form>
                    <div class="flex flex-wrap justify-between items-center mt-8 mb-4 gap-4">
                        <h3 class="text-lg font-semibold" id="accessories-title">Today's Accessories</h3>
                        <div class="flex items-center gap-2">
                             <label for="accessories-sort" class="text-sm font-medium">Sort by:</label>
                             <select id="accessories-sort" class="sort-select form-select p-2 border rounded-md text-sm" data-type="accessories">
                                 <option value="latest">Latest First</option>
                                 <option value="alphabetical">Brand (A-Z)</option>
                             </select>
                        </div>
                    </div>
                     <div class="table-container">
                        <table class="min-w-full responsive-table">
                            <thead>
                                <tr>
                                    <th class="py-2 px-4 border-b text-left" style="border-color: var(--border-primary);">Brand</th>
                                    <th class="py-2 px-4 border-b text-left" style="border-color: var(--border-primary);">Model</th>
                                    <th class="py-2 px-4 border-b text-left" style="border-color: var(--border-primary);">Variant</th>
                                    <th class="py-2 px-4 border-b text-left" style="border-color: var(--border-primary);">Type</th>
                                    <th class="py-2 px-4 border-b text-left" style="border-color: var(--border-primary);">Price</th>
                                    <th class="py-2 px-4 border-b text-left" style="border-color: var(--border-primary);">Date</th>
                                    <th class="py-2 px-4 border-b text-left" style="border-color: var(--border-primary);">Author</th>
                                    <th class="py-2 px-4 border-b text-center" style="border-color: var(--border-primary);">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="accessories-table-body"></tbody>
                        </table>
                    </div>
                </div>

                 <!-- Accessories Sell Out -->
                <div id="accessoriesSellOut" class="tab-pane hidden">
                    <h2 class="text-xl font-semibold mb-4">Record Accessory Sell Out</h2>
                     <form id="accessory-sell-out-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                         <select id="sell-out-accessory" class="form-select w-full p-2 border rounded-md md:col-span-full" required>
                             <option value="" disabled selected>Select Accessory to Sell</option>
                         </select>
                         <input type="text" id="sell-out-receipt" placeholder="Order Receipt #" class="form-input w-full p-2 border rounded-md">
                         <input type="text" id="sell-out-notes" placeholder="Notes" class="form-input w-full p-2 border rounded-md">
                         <button type="submit" style="background-color: var(--success);" class="md:col-span-full text-white font-semibold py-2 px-4 rounded-md transition-colors">Record Sell Out</button>
                    </form>

                     <div class="flex flex-wrap justify-between items-center mt-8 mb-4 gap-4">
                        <h3 class="text-lg font-semibold" id="accessories-sell-out-title">Today's Accessory Sales</h3>
                        <div class="flex items-center gap-4">
                             <div class="flex items-center gap-2">
                                <label for="accessoriesSellOut-sort" class="text-sm font-medium">Sort by:</label>
                                 <select id="accessoriesSellOut-sort" class="sort-select form-select p-2 border rounded-md text-sm" data-type="accessoriesSellOut">
                                     <option value="latest">Latest First</option>
                                     <option value="alphabetical">Brand (A-Z)</option>
                                 </select>
                            </div>
                            <button class="download-btn text-sm font-semibold py-2 px-4 rounded-md" data-type="accessoriesSellOut" style="background-color: var(--bg-tertiary);">Download CSV</button>
                        </div>
                    </div>
                    <div class="table-container">
                        <table class="min-w-full responsive-table">
                            <thead>
                                <tr>
                                    <th class="py-2 px-4 border-b text-left" style="border-color: var(--border-primary);">Brand</th>
                                    <th class="py-2 px-4 border-b text-left" style="border-color: var(--border-primary);">Model</th>
                                    <th class="py-2 px-4 border-b text-left" style="border-color: var(--border-primary);">Variant</th>
                                    <th class="py-2 px-4 border-b text-left" style="border-color: var(--border-primary);">Price</th>
                                    <th class="py-2 px-4 border-b text-left" style="border-color: var(--border-primary);">Date</th>
                                    <th class="py-2 px-4 border-b text-left" style="border-color: var(--border-primary);">Author</th>
                                    <th class="py-2 px-4 border-b text-center" style="border-color: var(--border-primary);">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="accessories-sell-out-table-body"></tbody>
                        </table>
                    </div>
                </div>

                <!-- Stock Transfer Out -->
                <div id="transferOut" class="tab-pane hidden">
                    <h2 class="text-xl font-semibold mb-4">Transfer Stock Out</h2>
                    <form id="transfer-out-form" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <input type="text" id="tout-imei" placeholder="15-Digit IMEI" class="form-input w-full p-2 border rounded-md" maxlength="15" required>
                        <input type="text" id="tout-notes" placeholder="Notes (e.g., Destination)" class="form-input w-full p-2 border rounded-md md:col-span-2 lg:col-span-2">
                        <button type="submit" style="background-color: var(--destructive);" class="md:col-span-2 lg:col-span-3 text-white font-semibold py-2 px-4 rounded-md transition-colors">Transfer Out</button>
                    </form>
                    <div class="flex flex-wrap justify-between items-center mt-8 mb-4 gap-4">
                        <h3 class="text-lg font-semibold" id="transfer-out-title">Today's Transfers Out</h3>
                        <div class="flex items-center gap-4">
                             <div class="flex items-center gap-2">
                                <label for="tout-sort" class="text-sm font-medium">Sort by:</label>
                                 <select id="tout-sort" class="sort-select form-select p-2 border rounded-md text-sm" data-type="transfersOut">
                                     <option value="latest">Latest First</option>
                                     <option value="alphabetical">Brand (A-Z)</option>
                                 </select>
                            </div>
                            <button class="download-btn text-sm font-semibold py-2 px-4 rounded-md" data-type="transfersOut" style="background-color: var(--bg-tertiary);">Download CSV</button>
                        </div>
                    </div>
                    <div class="table-container">
                        <table class="min-w-full responsive-table">
                            <thead>
                                <tr>
                                    <th class="py-2 px-4 border-b text-left" style="border-color: var(--border-primary);">IMEI</th>
                                    <th class="py-2 px-4 border-b text-left" style="border-color: var(--border-primary);">Brand</th>
                                    <th class="py-2 px-4 border-b text-left" style="border-color: var(--border-primary);">Model</th>
                                    <th class="py-2 px-4 border-b text-left" style="border-color: var(--border-primary);">Variant</th>
                                    <th class="py-2 px-4 border-b text-left" style="border-color: var(--border-primary);">Date</th>
                                    <th class="py-2 px-4 border-b text-left" style="border-color: var(--border-primary);">Author</th>
                                    <th class="py-2 px-4 border-b text-center" style="border-color: var(--border-primary);">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="transfer-out-table-body"></tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Stock Transfer In -->
                <div id="transferIn" class="tab-pane hidden">
                     <h2 class="text-xl font-semibold mb-4">Transfer Stock In</h2>
                    <form id="transfer-in-form" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <input type="text" id="tin-imei" placeholder="15-Digit IMEI" class="form-input w-full p-2 border rounded-md" maxlength="15" required>
                        <input type="text" id="tin-brand" placeholder="Brand" class="form-input w-full p-2 border rounded-md" required>
                        <input type="text" id="tin-model" placeholder="Model" class="form-input w-full p-2 border rounded-md" required>
                        <input type="text" id="tin-variant" placeholder="Variant" class="form-input w-full p-2 border rounded-md">
                        <input type="text" id="tin-color" placeholder="Color" class="form-input w-full p-2 border rounded-md">
                        <input type="number" id="tin-price" placeholder="Price" class="form-input w-full p-2 border rounded-md" required>
                        <input type="text" id="tin-notes" placeholder="Notes (e.g., Origin)" class="form-input md:col-span-2 lg:col-span-1 w-full p-2 border rounded-md">
                        <button type="submit" style="background-color: var(--special);" class="md:col-span-2 lg:col-span-3 text-white font-semibold py-2 px-4 rounded-md transition-colors">Transfer In</button>
                    </form>
                    <div class="flex flex-wrap justify-between items-center mt-8 mb-4 gap-4">
                        <h3 class="text-lg font-semibold" id="transfer-in-title">Today's Transfers In</h3>
                        <div class="flex items-center gap-4">
                            <div class="flex items-center gap-2">
                                <label for="tin-sort" class="text-sm font-medium">Sort by:</label>
                                 <select id="tin-sort" class="sort-select form-select p-2 border rounded-md text-sm" data-type="transfersIn">
                                     <option value="latest">Latest First</option>
                                     <option value="alphabetical">Brand (A-Z)</option>
                                 </select>
                            </div>
                            <button class="download-btn text-sm font-semibold py-2 px-4 rounded-md" data-type="transfersIn" style="background-color: var(--bg-tertiary);">Download CSV</button>
                        </div>
                    </div>
                    <div class="table-container">
                        <table class="min-w-full responsive-table">
                            <thead>
                                <tr>
                                    <th class="py-2 px-4 border-b text-left" style="border-color: var(--border-primary);">IMEI</th>
                                    <th class="py-2 px-4 border-b text-left" style="border-color: var(--border-primary);">Brand</th>
                                    <th class="py-2 px-4 border-b text-left" style="border-color: var(--border-primary);">Model</th>
                                    <th class="py-2 px-4 border-b text-left" style="border-color: var(--border-primary);">Variant</th>
                                    <th class="py-2 px-4 border-b text-left" style="border-color: var(--border-primary);">Date</th>
                                    <th class="py-2 px-4 border-b text-left" style="border-color: var(--border-primary);">Author</th>
                                    <th class="py-2 px-4 border-b text-center" style="border-color: var(--border-primary);">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="transfer-in-table-body"></tbody>
                        </table>
                    </div>
                </div>

                <!-- Stock Level -->
                <div id="stockLevel" class="tab-pane hidden">
                    <h2 class="text-xl font-semibold mb-4">Stock Level Check</h2>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div>
                            <h3 class="font-semibold text-lg mb-2" style="color: var(--success);">High Stock Products</h3>
                            <div id="high-stock-list" class="space-y-2"></div>
                        </div>
                         <div>
                            <h3 class="font-semibold text-lg mb-2" style="color: var(--destructive);">Low Stock Products</h3>
                            <div id="low-stock-list" class="space-y-2"></div>
                        </div>
                    </div>
                </div>
                
                <!-- Admin Tools -->
                <div id="admin" class="tab-pane hidden">
                    <h2 class="text-xl font-semibold mb-4">Manage User Roles</h2>
                    <div class="table-container">
                        <table class="min-w-full responsive-table">
                             <thead>
                                <tr>
                                    <th class="py-2 px-4 border-b text-left" style="border-color: var(--border-primary);">User Email</th>
                                    <th class="py-2 px-4 border-b text-left" style="border-color: var(--border-primary);">Current Role</th>
                                    <th class="py-2 px-4 border-b text-left" style="border-color: var(--border-primary);">Change Role</th>
                                    <th class="py-2 px-4 border-b text-center" style="border-color: var(--border-primary);">Manage</th>
                                </tr>
                            </thead>
                            <tbody id="user-management-table-body">
                                <!-- User list will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>

            </div>
        </div>
        
        <!-- Toast Notification -->
        <div id="toast" class="fixed bottom-5 right-5 text-white py-2 px-4 rounded-lg shadow-lg opacity-0 transition-opacity duration-300 z-50">
            <span id="toast-message"></span>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirm-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div style="background-color: var(--bg-secondary);" class="rounded-lg shadow-lg p-6 w-full max-w-sm text-center">
            <h3 class="text-lg font-bold mb-4" id="confirm-modal-title">Confirm Action</h3>
            <p style="color: var(--text-secondary);" class="mb-6" id="confirm-modal-message"></p>
            <div class="flex justify-center gap-4">
                <button id="confirm-cancel-btn" class="py-2 px-4 rounded-md font-semibold w-24" style="background-color: var(--bg-tertiary); color: var(--text-primary);">Cancel</button>
                <button id="confirm-ok-btn" class="py-2 px-4 rounded-md font-semibold text-white w-24">Confirm</button>
            </div>
        </div>
    </div>

     <!-- Kicked Modal -->
    <div id="kicked-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4">
        <div style="background-color: var(--bg-secondary);" class="rounded-lg shadow-lg p-6 w-full max-w-sm text-center">
            <h3 class="text-xl font-bold mb-4" style="color: var(--destructive);">Access Denied</h3>
            <p style="color: var(--text-secondary);" class="mb-6">Your account has been kicked by an administrator. Please contact support for more information.</p>
            <button id="kicked-ok-btn" class="py-2 px-4 rounded-md font-semibold text-white w-full" style="background-color: var(--accent-primary);">OK</button>
        </div>
    </div>

    <!-- Edit Item Modal -->
    <div id="edit-item-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div style="background-color: var(--bg-secondary);" class="rounded-lg shadow-lg p-6 w-full max-w-2xl">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold" id="edit-modal-title">Edit Stock Item</h3>
                <button id="edit-modal-close-btn">&times;</button>
            </div>
            <form id="edit-item-form">
                <input type="hidden" id="edit-item-id">
                <input type="hidden" id="edit-item-type">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div id="edit-imei-wrapper">
                        <label for="edit-imei" class="block text-sm font-medium mb-1">IMEI</label>
                        <input type="text" id="edit-imei" class="form-input w-full p-2 border rounded-md" maxlength="15" required disabled>
                    </div>
                    <div>
                        <label for="edit-brand" class="block text-sm font-medium mb-1">Brand</label>
                        <input type="text" id="edit-brand" placeholder="Brand" class="form-input w-full p-2 border rounded-md" required>
                    </div>
                    <div>
                        <label for="edit-model" class="block text-sm font-medium mb-1">Model</label>
                        <input type="text" id="edit-model" placeholder="Model" class="form-input w-full p-2 border rounded-md" required>
                    </div>
                    <div>
                        <label for="edit-variant" class="block text-sm font-medium mb-1">Variant</label>
                        <input type="text" id="edit-variant" placeholder="Variant" class="form-input w-full p-2 border rounded-md">
                    </div>
                    <div id="edit-color-wrapper">
                        <label for="edit-color" class="block text-sm font-medium mb-1">Color</label>
                        <input type="text" id="edit-color" placeholder="Color" class="form-input w-full p-2 border rounded-md">
                    </div>
                    <div id="edit-price-wrapper">
                        <label for="edit-price" class="block text-sm font-medium mb-1">Price</label>
                        <input type="number" id="edit-price" placeholder="Price" class="form-input w-full p-2 border rounded-md" required>
                    </div>
                    <div id="edit-incentive-wrapper" class="hidden">
                        <label for="edit-incentive" class="block text-sm font-medium mb-1">Incentive</label>
                        <input type="number" id="edit-incentive" placeholder="Incentive" class="form-input w-full p-2 border rounded-md">
                    </div>
                    <div id="edit-payment-wrapper" class="hidden">
                        <label for="edit-payment" class="block text-sm font-medium mb-1">Payment Method</label>
                        <select id="edit-payment" class="form-select w-full p-2 border rounded-md">
                            <option value="Cash">Cash</option>
                            <option value="Credit Card">Credit Card</option>
                            <option value="Digital Wallet">Digital Wallet</option>
                            <option value="Bank Transfer">Bank Transfer</option>
                            <option value="Others">Others</option>
                        </select>
                    </div>
                    <div id="edit-receipt-number-wrapper" class="hidden">
                        <label for="edit-receipt-number" class="block text-sm font-medium mb-1">Receipt #</label>
                        <input type="text" id="edit-receipt-number" placeholder="Order Receipt #" class="form-input w-full p-2 border rounded-md">
                    </div>
                    <div class="md:col-span-2">
                        <label for="edit-notes" class="block text-sm font-medium mb-1">Notes</label>
                        <textarea id="edit-notes" placeholder="Notes" class="form-input w-full p-2 border rounded-md" rows="2"></textarea>
                    </div>
                </div>
                <div class="flex justify-end gap-4 mt-6">
                     <button type="button" id="edit-modal-cancel-btn" class="py-2 px-4 rounded-md font-semibold w-32" style="background-color: var(--bg-tertiary); color: var(--text-primary);">Cancel</button>
                     <button type="submit" class="py-2 px-4 rounded-md font-semibold text-white w-32" style="background-color: var(--success);">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <!-- UPDATED: IMEI Scanner Modal -->
    <div id="scanner-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex flex-col items-center justify-center z-50 p-4">
        <div style="background-color: var(--bg-secondary);" class="rounded-lg shadow-lg p-6 w-full max-w-md text-center relative">
            <h3 class="text-lg font-bold mb-4">Scan IMEI Barcode</h3>
            <div class="w-full rounded-md overflow-hidden bg-gray-200" style="aspect-ratio: 1/1;">
                 <div id="reader"></div>
            </div>
            <p id="scanner-status" class="mt-2 text-sm" style="color: var(--text-secondary); min-height: 1.25rem;"></p>
            <button id="start-scan-btn" class="mt-2 py-2 px-4 rounded-md font-semibold w-full text-white" style="background-color: var(--accent-primary);">Start Scanning</button>
            <button id="scanner-close-btn" class="mt-2 py-2 px-4 rounded-md font-semibold w-full" style="background-color: var(--bg-tertiary); color: var(--text-primary);">Cancel</button>
        </div>
    </div>


<script type="module">
    // --- Firebase SDKs ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { 
        getAuth, 
        onAuthStateChanged, 
        createUserWithEmailAndPassword, 
        signInWithEmailAndPassword, 
        signOut 
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { 
        getFirestore, 
        doc, 
        setDoc,
        updateDoc,
        deleteDoc,
        getDoc,
        getDocs,
        addDoc, 
        collection, 
        query, 
        onSnapshot,
        where,
        limit,
        serverTimestamp,
        runTransaction
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // This is a hardcoded Firebase configuration. In a production environment,
    // this should be loaded from environment variables or a secure source.
    const firebaseConfig = {
        apiKey: "AIzaSyCRoM0688XXI5q51uV_dBPVu6pmomSGwss",
        authDomain: "inventory-d4c22.firebaseapp.com",
        databaseURL: "https://inventory-d4c22-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "inventory-d4c22",
        storageBucket: "inventory-d4c22.appspot.com",
        messagingSenderId: "99206301025",
        appId: "1:99206301025:web:8c636434bdfb69af3a3120",
        measurementId: "G-5C5DETNZG7"
    };

    // --- Firebase Initialization ---
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // --- Global State ---
    let currentUserRole = null;
    let currentUserEmail = null;
    let usersUnsubscribe = null;
    let inventoryUnsubscribe = null;
    let salesUnsubscribe = null;
    let transfersInUnsubscribe = null;
    let transfersOutUnsubscribe = null;
    let deliveriesUnsubscribe = null;
    let accessoriesUnsubscribe = null;
    let accessoriesSellOutUnsubscribe = null;
    let inventory = [];
    let sales = [];
    let transfersIn = [];
    let transfersOut = [];
    let deliveries = [];
    let accessories = [];
    let accessoriesSellOut = [];
    let selectedDate = new Date();
    
    // --- UI Elements ---
    const authContainer = document.getElementById('auth-container');
    const appContainer = document.getElementById('app-container');
    const authError = document.getElementById('auth-error');
    const dateFilter = document.getElementById('date-filter');
    const gotoTodayBtn = document.getElementById('goto-today-btn');
    const downloadReportBtn = document.getElementById('download-report-btn');

    const signinForm = document.getElementById('signin-form');
    const signupForm = document.getElementById('signup-form');

    const showSignupBtn = document.getElementById('show-signup-btn');
    const showSigninBtn = document.getElementById('show-signin-btn');

    const signinBtn = document.getElementById('signin-btn');
    const signupBtn = document.getElementById('signup-btn');
    const signoutBtn = document.getElementById('signout-btn');
    
    const confirmModal = document.getElementById('confirm-modal');
    const confirmOkBtn = document.getElementById('confirm-ok-btn');
    const confirmCancelBtn = document.getElementById('confirm-cancel-btn');
    const confirmModalTitle = document.getElementById('confirm-modal-title');
    const confirmModalMessage = document.getElementById('confirm-modal-message');

    const kickedModal = document.getElementById('kicked-modal');
    const kickedOkBtn = document.getElementById('kicked-ok-btn');

    const editItemModal = document.getElementById('edit-item-modal');
    const editItemForm = document.getElementById('edit-item-form');
    const editModalCloseBtn = document.getElementById('edit-modal-close-btn');
    const editModalCancelBtn = document.getElementById('edit-modal-cancel-btn');
    const editModalTitle = document.getElementById('edit-modal-title');
    const searchBtn = document.getElementById('search-btn');
    const searchInput = document.getElementById('search-input');
    const searchResultsContainer = document.getElementById('search-results-container');

    // Scanner elements
    const scanImeiBtn = document.getElementById('scan-imei-btn');
    const scannerModal = document.getElementById('scanner-modal');
    const startScanBtn = document.getElementById('start-scan-btn');
    const scannerCloseBtn = document.getElementById('scanner-close-btn');
    const scannerStatus = document.getElementById('scanner-status');

    // Delivery form inputs (for auto-fill)
    const delImeiInput = document.getElementById('del-imei');
    const delBrandInput = document.getElementById('del-brand');
    const delModelInput = document.getElementById('del-model');
    const delVariantInput = document.getElementById('del-variant');
    const delColorInput = document.getElementById('del-color');
    const delPriceInput = document.getElementById('del-price');
    const delNotesInput = document.getElementById('del-notes');
    const deliveryForm = document.getElementById('delivery-form');

    // --- DARK MODE ---
    const darkModeToggle = document.getElementById("darkModeToggle");
    
    function applyDarkMode(isDark) { 
        document.documentElement.classList.toggle('dark', isDark);
        localStorage.setItem("darkMode", isDark);
    }
    
    const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
    const savedMode = localStorage.getItem("darkMode");
    const initialDarkMode = savedMode !== null ? savedMode === 'true' : prefersDark;
    darkModeToggle.checked = initialDarkMode;
    applyDarkMode(initialDarkMode);


    // --- UTILITY FUNCTIONS ---
    const showToast = (message, type = 'success') => {
        const toast = document.getElementById('toast');
        const toastMessage = document.getElementById('toast-message');
        toastMessage.textContent = message;

        toast.style.backgroundColor = '';

        if (type === 'error') {
            toast.style.backgroundColor = 'var(--destructive)';
        } else {
            toast.style.backgroundColor = 'var(--success)';
        }

        toast.classList.remove('opacity-0');
        toast.classList.add('opacity-100');

        setTimeout(() => {
            toast.classList.remove('opacity-100');
            toast.classList.add('opacity-0');
        }, 3000);
    };
    
    let confirmCallback = null;
    const showConfirm = (message, onConfirm, options = {}) => {
        const { title = 'Confirm Action', okText = 'Confirm', okClass = 'destructive' } = options;
        
        confirmModalTitle.textContent = title;
        confirmModalMessage.textContent = message;
        confirmOkBtn.textContent = okText;

        confirmOkBtn.style.backgroundColor = ''; // Reset
        if(okClass === 'destructive') {
            confirmOkBtn.style.backgroundColor = 'var(--destructive)';
        } else {
            confirmOkBtn.style.backgroundColor = 'var(--success)';
        }

        confirmModal.classList.remove('hidden');
        confirmCallback = onConfirm;
    };

    confirmOkBtn.addEventListener('click', () => {
        if (confirmCallback) {
            confirmCallback();
        }
        confirmModal.classList.add('hidden');
        confirmCallback = null;
    });

    confirmCancelBtn.addEventListener('click', () => {
        confirmModal.classList.add('hidden');
        confirmCallback = null;
    });

    kickedOkBtn.addEventListener('click', () => {
        kickedModal.classList.add('hidden');
    });

    const formatCurrency = (amount) => {
        return new Intl.NumberFormat('en-PH', { style: 'currency', currency: 'PHP' }).format(amount);
    };

    const formatDate = (date) => {
        // Handle both JS Date objects and Firestore Timestamps
        if (!date) return 'N/A';
        const dateObj = date.toDate ? date.toDate() : new Date(date);
        return dateObj.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
    }
    
    // --- TAB MANAGEMENT ---
    window.changeTab = (tabName) => {
        document.querySelectorAll('.tab-pane').forEach(pane => {
            pane.classList.add('hidden');
        });
        document.getElementById(tabName).classList.remove('hidden');

        document.querySelectorAll('.tab').forEach(tab => {
            tab.classList.remove('tab-active');
            tab.style.color = 'var(--text-secondary)';
            tab.style.borderColor = 'transparent';
        });
        const activeTab = document.querySelector(`.tab[data-tab="${tabName}"]`);
        if (activeTab) {
            activeTab.classList.add('tab-active');
            activeTab.style.color = 'var(--accent-primary)';
            activeTab.style.borderColor = 'var(--accent-primary)';
        }

    };

    // --- RENDERING FUNCTIONS ---
    const renderAll = () => {
        const activeTab = document.querySelector('.tab-active')?.dataset.tab;
        if (!activeTab) return;
        
        const sortType = document.querySelector(`#${activeTab}-sort`)?.value || 'latest';

        renderDashboard();
        renderStockTable(sortType);
        renderSalesTable(sortType);
        renderStockLevels();
        renderDeliveriesTable(sortType);
        renderTransfersInTable(sortType);
        renderTransfersOutTable(sortType);
        renderAccessoriesTable(sortType);
        renderAccessoriesSellOutTable(sortType);
    };

    const renderDashboard = () => {
        const formattedDate = formatDate(selectedDate);
        document.getElementById('dashboard-sales-title').textContent = `Sales for ${formattedDate}`;
        document.getElementById('dashboard-incentives-title').textContent = `Incentives for ${formattedDate}`;

        const totalSales = sales.reduce((sum, item) => sum + (item.price || 0), 0);
        const totalIncentives = sales.reduce((sum, item) => sum + (item.incentive || 0), 0);
        
        document.getElementById('dashboard-sales').textContent = formatCurrency(totalSales);
        document.getElementById('dashboard-stock').textContent = inventory.length;
        document.getElementById('dashboard-incentives').textContent = formatCurrency(totalIncentives);
    };
    
    const renderStockTable = (sortType = 'latest') => {
        const tableBody = document.getElementById('stock-table-body');
        tableBody.innerHTML = '';

        let sortedData = [...inventory];
        if(sortType === 'alphabetical') {
            sortedData.sort((a,b) => (a.brand || '').localeCompare(b.brand || ''));
        } else { // 'latest'
            sortedData.sort((a,b) => (b.addedAt?.toMillis?.() || 0) - (a.addedAt?.toMillis?.() || 0));
        }

        if (sortedData.length === 0) {
            tableBody.innerHTML = `<tr><td colspan="8" class="text-center py-4" style="color: var(--text-secondary);">No items in stock.</td></tr>`;
            return;
        }
        sortedData.forEach(item => {
            const canEdit = currentUserRole === 'admin' || currentUserRole === 'editor';
            const isAdmin = currentUserRole === 'admin';
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td class="py-2 px-4" data-label="IMEI">${item.imei || 'N/A'}</td>
                <td class="py-2 px-4" data-label="Brand">${item.brand || 'N/A'}</td>
                <td class="py-2 px-4" data-label="Model">${item.model || 'N/A'}</td>
                <td class="py-2 px-4" data-label="Variant">${item.variant || ''}</td>
                <td class="py-2 px-4" data-label="Date Added">${formatDate(item.addedAt)}</td>
                <td class="py-2 px-4" data-label="Author">${item.author || 'N/A'}</td>
                <td class="py-2 px-4 text-center" data-label="Actions">
                    <button class="edit-btn px-2 py-1 text-sm rounded-md" data-imei="${item.imei}" ${canEdit ? '' : 'disabled'} style="background-color: var(--bg-tertiary);">Edit</button>
                </td>
            `;
            tableBody.appendChild(tr);
        });
    };

    // Placeholder functions for other renderers (they can be implemented elsewhere)
    const renderSalesTable = () => {};
    const renderStockLevels = () => {};
    const renderDeliveriesTable = () => {};
    const renderTransfersInTable = () => {};
    const renderTransfersOutTable = () => {};
    const renderAccessoriesTable = () => {};
    const renderAccessoriesSellOutTable = () => {};

    // --- SCANNER IMPLEMENTATION ---
    // We'll use the globally loaded Html5Qrcode (from unpkg script tag).
    let html5QrCodeInstance = null;
    let scanning = false;
    let lastScannedValue = null;

    const openScannerModal = () => {
        scannerStatus.textContent = '';
        scannerModal.classList.remove('hidden');
    };

    const closeScannerModal = async () => {
        scannerModal.classList.add('hidden');
        scannerStatus.textContent = '';
        lastScannedValue = null;
        if (html5QrCodeInstance && scanning) {
            try {
                await html5QrCodeInstance.stop();
            } catch (err) {
                // ignore stop errors
            }
            html5QrCodeInstance.clear().catch(()=>{});
            html5QrCodeInstance = null;
            scanning = false;
        }
    };

    // Heuristic parser to extract IMEI and obvious fields from scanned text.
    // Many IMEI barcodes contain just a 15-digit number. Some vendor barcodes have labels like "IMEI:", "S/N:", "Model:", etc.
    function parseScannedText(scannedText) {
        const result = {
            imei: null,
            brand: null,
            model: null,
            variant: null,
            color: null,
            price: null,
            notes: scannedText
        };

        if (!scannedText) return result;

        // Try to find a 15-digit IMEI inside scannedText
        const imeiMatch = scannedText.match(/(\d{15})/);
        if (imeiMatch) {
            result.imei = imeiMatch[1];
        }

        // Try simple key:value parsing (e.g., "IMEI: 12345; MODEL: Foo; BRAND: Bar")
        const kvPairs = scannedText.split(/[\n\r;\/|,]+/).map(s => s.trim()).filter(Boolean);
        kvPairs.forEach(part => {
            const m = part.match(/^\s*([A-Za-z\-\_\s]+)[:=]\s*(.+)$/);
            if (m) {
                const key = m[1].trim().toLowerCase();
                const value = m[2].trim();
                if (key.includes('imei') && !result.imei) {
                    const mI = value.match(/(\d{15})/);
                    if (mI) result.imei = mI[1];
                } else if (key.includes('brand') || key.includes('vendor')) {
                    result.brand = value;
                } else if (key.includes('model') || key.includes('mod')) {
                    result.model = value;
                } else if (key.includes('variant') || key.includes('storage') || key.includes('gb')) {
                    result.variant = value;
                } else if (key.includes('color')) {
                    result.color = value;
                } else if (key.includes('price') || key.includes('php') || key.includes('₱')) {
                    const digits = value.replace(/[^\d.]/g, '');
                    if (digits) result.price = parseFloat(digits);
                }
            } else {
                // If token looks like MODEL123 or AB-123, heuristically map it to model if model is empty
                if (!result.model && /[A-Za-z0-9\-]{3,}/.test(part) && !/^\d{15}$/.test(part)) {
                    // if it contains letters and digits it's likely a model/sku
                    result.model = part;
                }
            }
        });

        // If nothing found for model/brand, attempt to match known patterns like "SM-G991B" (Samsung)
        const modelLike = scannedText.match(/([A-Z0-9]{2,}-[A-Z0-9]{2,}|SM-[A-Z0-9\-]+|M[0-9]{3,})/i);
        if (!result.model && modelLike) {
            result.model = modelLike[0];
        }

        return result;
    }

    async function startScanning() {
        if (scanning) return;
        scannerStatus.textContent = 'Initializing camera...';
        try {
            // eslint-disable-next-line no-undef
            const Html5Qrcode = window.Html5Qrcode;
            if (!Html5Qrcode) {
                throw new Error('Html5Qrcode library not loaded.');
            }

            html5QrCodeInstance = new Html5Qrcode("reader", { verbose: false });
            const devices = await Html5Qrcode.getCameras();
            if (!devices || devices.length === 0) {
                scannerStatus.textContent = 'No camera found.';
                showToast('No camera found on this device.', 'error');
                return;
            }
            // prefer back camera if available
            const backCamera = devices.find(d => /back|rear|environment/gi.test(d.label)) || devices[0];
            const cameraId = backCamera.id;

            scannerStatus.textContent = 'Point the camera at the IMEI barcode...';
            scanning = true;

            await html5QrCodeInstance.start(
                cameraId,
                {
                    fps: 10,
                    qrbox: { width: 300, height: 200 },
                    // Set types if you want to restrict; we'll accept all text
                },
                (decodedText, decodedResult) => {
                    // On successful scan
                    if (!decodedText) return;
                    // Avoid duplicate rapid scans
                    if (lastScannedValue === decodedText) return;
                    lastScannedValue = decodedText;
                    scannerStatus.textContent = `Scanned: ${decodedText}`;
                    // Parse
                    const parsed = parseScannedText(decodedText);
                    if (!parsed.imei) {
                        showToast('No 15-digit IMEI detected in the barcode. Please try again.', 'error');
                        return;
                    }

                    // Stop scanning once we have an IMEI (we will process it)
                    html5QrCodeInstance.stop().then(() => {
                        scanning = false;
                        html5QrCodeInstance.clear().catch(()=>{});
                        html5QrCodeInstance = null;
                        // Auto-fill the delivery form with parsed data
                        autofillDeliveryForm(parsed);
                        // Optionally persist immediately to database
                        // We'll ask user to confirm saving via a toast + filling the form.
                        showToast('IMEI detected — delivery form auto-filled. Review and submit to save.', 'success');
                        // Close scanner modal after brief delay so user can see status
                        setTimeout(() => closeScannerModal(), 900);
                    }).catch(err => {
                        scanning = false;
                        html5QrCodeInstance = null;
                        showToast('Stopped scanner due to error.', 'error');
                    });

                },
                (errorMessage) => {
                    // optional callback for scan failure / decode errors
                }
            );
        } catch (err) {
            console.error('Scanner error:', err);
            scannerStatus.textContent = 'Scanner initialization failed: ' + (err.message || err);
            showToast('Scanner initialization failed.', 'error');
            scanning = false;
            if (html5QrCodeInstance) {
                try { await html5QrCodeInstance.clear(); } catch(e){}
                html5QrCodeInstance = null;
            }
        }
    }

    // Fill the delivery form fields with parsed values
    function autofillDeliveryForm(parsed) {
        if (!parsed) return;
        if (parsed.imei) delImeiInput.value = parsed.imei;
        if (parsed.brand) delBrandInput.value = parsed.brand;
        if (parsed.model) delModelInput.value = parsed.model;
        if (parsed.variant) delVariantInput.value = parsed.variant;
        if (parsed.color) delColorInput.value = parsed.color;
        if (parsed.price) delPriceInput.value = parsed.price;
        if (parsed.notes) delNotesInput.value = parsed.notes;
        // bring user to deliveries tab automatically
        changeTab('deliveries');
        // focus on Add button so user can submit quickly
        setTimeout(()=> {
            const submitBtn = deliveryForm.querySelector('button[type="submit"]');
            if (submitBtn) submitBtn.focus();
        }, 300);
    }

    // Persistence: when the delivery form is submitted, save to Firestore 'deliveries' and (optionally) 'inventory'
    deliveryForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const imei = delImeiInput.value.trim();
        if (!/^\d{15}$/.test(imei)) {
            showToast('Please enter a valid 15-digit IMEI.', 'error');
            return;
        }
        const docData = {
            imei,
            brand: delBrandInput.value.trim() || null,
            model: delModelInput.value.trim() || null,
            variant: delVariantInput.value.trim() || null,
            color: delColorInput.value.trim() || null,
            price: parseFloat(delPriceInput.value) || 0,
            notes: delNotesInput.value.trim() || null,
            author: currentUserEmail || 'unknown',
            createdAt: serverTimestamp()
        };
        try {
            // Save to 'deliveries'
            await addDoc(collection(db, 'deliveries'), docData);
            // Also add to 'inventory' (if you want deliveries to also be inventory items)
            // You might instead require manual transfer-in process; here we add to inventory for convenience.
            const inventoryData = {
                imei,
                brand: docData.brand,
                model: docData.model,
                variant: docData.variant,
                color: docData.color,
                price: docData.price,
                author: docData.author,
                addedAt: serverTimestamp()
            };
            await addDoc(collection(db, 'inventory'), inventoryData);

            showToast('Delivery saved and inventory updated.', 'success');

            // Clear form
            deliveryForm.reset();
            // Re-render / refresh streams elsewhere (if listeners exist this will happen)
        } catch (err) {
            console.error('Failed to save delivery:', err);
            showToast('Failed to save. Check console for details.', 'error');
        }
    });

    // Hook scanner buttons
    scanImeiBtn.addEventListener('click', () => {
        openScannerModal();
    });

    startScanBtn.addEventListener('click', () => {
        startScanning();
    });

    scannerCloseBtn.addEventListener('click', () => {
        closeScannerModal();
    });

    // Close scanner when clicking outside modal content (optional)
    scannerModal.addEventListener('click', (ev) => {
        if (ev.target === scannerModal) {
            closeScannerModal();
        }
    });

    // --- AUTH STATE HANDLING (simplified for demo) ---
    onAuthStateChanged(auth, (user) => {
        if (user) {
            currentUserEmail = user.email;
            // Example: retrieve role from 'users' collection or custom claims
            // For now assume role 'editor' for logged-in users except some admin emails
            // In production, derive role from Firestore or Auth custom claims
            // We'll try to read a document in users/{uid} for role
            (async() => {
                try {
                    const uDoc = await getDoc(doc(db, 'users', user.uid));
                    if (uDoc.exists()) {
                        currentUserRole = uDoc.data().role || 'editor';
                    } else {
                        currentUserRole = 'editor';
                    }
                } catch(e) {
                    currentUserRole = 'editor';
                }
                // Update UI
                authContainer.classList.add('hidden');
                appContainer.classList.remove('hidden');
                document.getElementById('user-email').textContent = currentUserEmail;
                document.getElementById('user-role-badge').textContent = currentUserRole;
                if (currentUserRole === 'admin') {
                    document.getElementById('admin-tab-btn').classList.remove('hidden');
                }
            })();
        } else {
            // show auth view
            currentUserEmail = null;
            currentUserRole = null;
            authContainer.classList.remove('hidden');
            appContainer.classList.add('hidden');
        }
    });

    // Basic sign-in/up handlers (simplified)
    signinBtn.addEventListener('click', async () => {
        const email = document.getElementById('signin-email').value.trim();
        const pass = document.getElementById('signin-password').value;
        try {
            await signInWithEmailAndPassword(auth, email, pass);
            showToast('Signed in', 'success');
        } catch (err) {
            console.error(err);
            authError.style.display = 'block';
            authError.textContent = err.message || 'Failed to sign in';
            showToast('Sign-in failed', 'error');
        }
    });

    signupBtn.addEventListener('click', async () => {
        const email = document.getElementById('signup-email').value.trim();
        const pass = document.getElementById('signup-password').value;
        try {
            const userCred = await createUserWithEmailAndPassword(auth, email, pass);
            // create user metadata document
            await setDoc(doc(db, 'users', userCred.user.uid), { email, role: 'editor', createdAt: serverTimestamp() });
            showToast('Account created', 'success');
        } catch (err) {
            console.error(err);
            authError.style.display = 'block';
            authError.textContent = err.message || 'Failed to sign up';
            showToast('Sign-up failed', 'error');
        }
    });

    showSignupBtn.addEventListener('click', () => {
        signinForm.classList.add('hidden');
        signupForm.classList.remove('hidden');
    });

    showSigninBtn.addEventListener('click', () => {
        signupForm.classList.add('hidden');
        signinForm.classList.remove('hidden');
    });

    signoutBtn.addEventListener('click', async () => {
        try {
            await signOut(auth);
            showToast('Signed out', 'success');
        } catch (err) {
            console.error(err);
            showToast('Sign out failed', 'error');
        }
    });

    // Dark mode toggle
    darkModeToggle.addEventListener('change', (e) => {
        applyDarkMode(e.target.checked);
    });

    // Small UX: set today's date in date filter
    const todayISO = new Date().toISOString().slice(0,10);
    if (dateFilter) dateFilter.value = todayISO;

    // ----- WHAT'S NEXT -----
    // The scanner now:
    // - opens camera modal
    // - scans barcodes and looks for a 15-digit IMEI
    // - parses basic fields and auto-fills the "Add Delivery" form
    // - on delivery submit, saves to both 'deliveries' and 'inventory' collections in Firestore
    //
    // Next improvements you might want:
    // - Use more robust parsing for specific vendor barcode formats (GS1, custom labels) and map exact AIs.
    // - Add an option to auto-save immediately after scan or ask for manual confirmation.
    // - Add server-side verification to prevent duplicate IMEIs in inventory.
    // - Improve UI for camera selection and fallback for devices without cameras.
    //
    // If you'd like, I can:
    // - Add "auto-save on scan" toggle.
    // - Implement duplicate IMEI checks and show a conflict resolution modal.
    // - Parse GS1 AI elements (like (01) GTIN or (10) batch) if you provide sample barcodes.
    //
    // Tell me which of these you'd like next and I will update the code accordingly.

</script>
</body>
</html>
```
